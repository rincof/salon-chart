<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>ç¾å®¹å®¤ã‚«ãƒ«ãƒ†ã‚·ã‚¹ãƒ†ãƒ  - LINEé€£æºç‰ˆ</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 10px; }
.container { max-width: 100%; background: white; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.2); overflow: hidden; }
.header { background: linear-gradient(45deg, #667eea, #764ba2); color: white; padding: 25px; text-align: center; }
.header h1 { font-size: 28px; font-weight: 700; margin-bottom: 5px; }
.header p { font-size: 14px; opacity: 0.9; }
.search-bar { background: rgba(255,255,255,0.15); padding: 20px 25px; border-bottom: 1px solid rgba(255,255,255,0.2); }
.search-input { width: 100%; padding: 12px 20px; border: none; border-radius: 25px; font-size: 16px; background: white; }
.main-content { display: flex; }
.sidebar { width: 380px; background: linear-gradient(180deg, #ffeaa7, #fdcb6e); padding: 20px; overflow-y: auto; max-height: calc(100vh - 200px); }
.content-area { flex: 1; padding: 20px; background: #f8f9fa; overflow-y: auto; max-height: calc(100vh - 200px); }
.section { background: white; border-radius: 15px; padding: 20px; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.08); border-left: 4px solid #667eea; }
.section h3 { color: #2d3436; margin-bottom: 20px; font-size: 18px; font-weight: 700; }
.form-group { margin-bottom: 18px; }
.form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #2d3436; font-size: 14px; }
.form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px 15px; border: 2px solid #ddd; border-radius: 10px; font-size: 16px; font-family: inherit; }
.form-group input:focus { outline: none; border-color: #667eea; }
.form-row { display: flex; gap: 15px; }
.form-row .form-group { flex: 1; }
.line-section { background: #e7f9f0; border: 3px solid #06C755; border-radius: 15px; padding: 20px; margin-top: 20px; }
.line-section h4 { color: #06C755; margin-bottom: 15px; font-size: 16px; font-weight: 700; }
.line-btn { width: 100%; padding: 15px; background: #06C755; color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 700; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 10px; }
.line-btn:disabled { background: #ccc; cursor: not-allowed; }
.line-btn:not(:disabled):active { transform: scale(0.98); }
.tools-section { margin-bottom: 25px; }
.tools-section h4 { color: #636e72; margin-bottom: 15px; font-size: 15px; font-weight: 700; }
.tool-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
.tool-btn { padding: 15px; border: 3px solid #fdcb6e; border-radius: 12px; background: white; cursor: pointer; text-align: center; font-size: 14px; font-weight: 700; transition: all 0.3s; }
.tool-btn.active { border-color: #667eea; background: #f8f9ff; transform: scale(1.05); }
.color-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 15px; }
.color-btn { width: 45px; height: 45px; border-radius: 50%; cursor: pointer; border: 3px solid transparent; box-shadow: 0 3px 10px rgba(0,0,0,0.2); transition: all 0.2s; }
.color-btn.active { border-color: #333; transform: scale(1.15); }
.slider-container { margin: 15px 0; }
.slider { width: 100%; height: 6px; border-radius: 3px; background: #ddd; outline: none; -webkit-appearance: none; }
.slider::-webkit-slider-thumb { appearance: none; width: 24px; height: 24px; border-radius: 50%; background: #667eea; cursor: pointer; }
.size-display { text-align: center; font-size: 14px; color: #636e72; margin-top: 8px; font-weight: 600; }
.canvas-container { position: relative; width: 100%; height: 550px; border: 4px solid #667eea; border-radius: 15px; background: white; margin: 20px 0; overflow: hidden; }
#drawingCanvas { position: absolute; top: 0; left: 0; cursor: crosshair; touch-action: none; }
.head-illustration { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; pointer-events: none; }
.head-views { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px; }
.view-btn { padding: 12px; border: 3px solid #fdcb6e; border-radius: 12px; background: white; cursor: pointer; font-size: 13px; font-weight: 700; text-align: center; transition: all 0.3s; }
.view-btn.active { background: #667eea; color: white; border-color: #667eea; }
.quick-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 20px; }
.quick-btn { padding: 12px; border: none; border-radius: 10px; background: #74b9ff; color: white; cursor: pointer; font-size: 14px; font-weight: 700; transition: all 0.3s; }
.quick-btn:active { transform: scale(0.95); }
.action-buttons { display: flex; gap: 15px; margin: 30px 0; }
.btn { flex: 1; padding: 15px; border: none; border-radius: 25px; font-size: 16px; font-weight: 700; cursor: pointer; transition: all 0.3s; }
.btn-primary { background: #00b894; color: white; }
.btn-secondary { background: #74b9ff; color: white; }
.btn:active { transform: scale(0.98); }
.status-indicator { position: fixed; top: 20px; right: 20px; background: #00b894; color: white; padding: 12px 20px; border-radius: 20px; font-size: 14px; font-weight: 600; opacity: 0; transition: opacity 0.3s; z-index: 1000; box-shadow: 0 5px 20px rgba(0,0,0,0.3); }
.status-indicator.show { opacity: 1; }
@media (max-width: 1024px) {
    .main-content { flex-direction: column; }
    .sidebar { width: 100%; max-height: none; }
    .canvas-container { height: 400px; }
}
</style>
</head>
<body>
<div class="container">
<div class="header">
<h1>ç¾å®¹å®¤ã‚«ãƒ«ãƒ†ã‚·ã‚¹ãƒ†ãƒ </h1>
<p>LINEé€£æºå¯¾å¿œ - iPadæœ€é©åŒ–ç‰ˆ</p>
</div>

<div class="search-bar">
<input type="text" class="search-input" placeholder="ãŠå®¢æ§˜ã®åå‰ã¾ãŸã¯IDã§æ¤œç´¢...">
</div>

<div class="main-content">
<div class="sidebar">
<div class="section">
<h3>ãŠå®¢æ§˜æƒ…å ±</h3>
<div class="form-group">
<label>é¡§å®¢ID</label>
<input type="text" id="customerId" readonly>
</div>
<div class="form-group">
<label>ãŠåå‰</label>
<input type="text" id="customerName" placeholder="å±±ç”° èŠ±å­">
</div>
<div class="form-row">
<div class="form-group">
<label>å¹´é½¢</label>
<input type="number" id="customerAge" placeholder="25">
</div>
<div class="form-group">
<label>æ¥åº—æ—¥</label>
<input type="date" id="visitDate">
</div>
</div>
<div class="form-group">
<label>æ‹…å½“ã‚¹ã‚¿ã‚¤ãƒªã‚¹ãƒˆ</label>
<input type="text" id="stylistName" placeholder="ç”°ä¸­">
</div>

<div class="line-section">
<h4>ğŸ“± LINEé€£æº</h4>
<div class="form-group">
<label>LINE ID</label>
<input type="text" id="lineId" placeholder="ä¾‹: @salon123 ã¾ãŸã¯ LINE ID">
</div>
<button class="line-btn" id="sendLineBtn" disabled>
<span style="font-size: 20px;">ğŸ’¬</span>
<span>LINEã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚‹</span>
</button>
<p style="font-size: 12px; color: #666; margin-top: 10px;">â€» LINE IDã‚’å…¥åŠ›ã™ã‚‹ã¨é€ä¿¡ãƒœã‚¿ãƒ³ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã™</p>
</div>
</div>

<div class="section">
<h3>é¡§å®¢ä¸€è¦§</h3>
<div class="form-group">
<input type="text" id="customerSearch" placeholder="é¡§å®¢åã§æ¤œç´¢..." style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 10px; font-size: 16px;">
</div>
<div id="customerList" style="max-height: 300px; overflow-y: auto;">
<div style="text-align: center; color: #999; padding: 20px;">ä¿å­˜ã•ã‚ŒãŸé¡§å®¢ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</div>
</div>
</div>

<div class="section">
<h3>æç”»ãƒ„ãƒ¼ãƒ«</h3>
<div class="tools-section">
<h4>åŸºæœ¬ãƒ„ãƒ¼ãƒ«</h4>
<div class="tool-grid">
<div class="tool-btn active" id="penTool">ãƒšãƒ³</div>
<div class="tool-btn" id="eraserTool">æ¶ˆã—ã‚´ãƒ </div>
</div>
</div>
<div class="tools-section">
<h4>ç·šã®å¤ªã•</h4>
<div class="slider-container">
<input type="range" class="slider" id="brushSize" min="1" max="20" value="3">
<div class="size-display" id="sizeDisplay">3px</div>
</div>
</div>
<div class="tools-section">
<h4>è‰²é¸æŠ</h4>
<div class="color-grid">
<div class="color-btn active" style="background:#000" data-color="#000"></div>
<div class="color-btn" style="background:#f00" data-color="#f00"></div>
<div class="color-btn" style="background:#00f" data-color="#00f"></div>
<div class="color-btn" style="background:#0a0" data-color="#0a0"></div>
<div class="color-btn" style="background:#f60" data-color="#f60"></div>
<div class="color-btn" style="background:#90f" data-color="#90f"></div>
<div class="color-btn" style="background:#f19" data-color="#f19"></div>
<div class="color-btn" style="background:#842" data-color="#842"></div>
</div>
</div>
<div class="quick-actions">
<button class="quick-btn" id="undoBtn">â†¶ å‰ã«æˆ»ã‚‹</button>
<button class="quick-btn" id="redoBtn">â†· æ¬¡ã¸é€²ã‚€</button>
</div>
</div>
</div>
<!-- ãƒ‘ãƒ¼ãƒˆ2ã¯ã“ã“ã¾ã§ã€‚ç¶šãã¾ã™... -->
</div>

<div class="content-area">
<div class="section">
<h3>ãƒ˜ã‚¢ã‚¹ã‚¿ã‚¤ãƒ«è¨­è¨ˆå›³</h3>
<div class="head-views">
<div class="view-btn active" data-view="front">æ­£é¢</div>
<div class="view-btn" data-view="back">èƒŒé¢</div>
<div class="view-btn" data-view="left">å·¦å´é¢</div>
<div class="view-btn" data-view="right">å³å´é¢</div>
<div class="view-btn" data-view="left-front">å·¦æ–œã‚å‰</div>
<div class="view-btn" data-view="right-front">å³æ–œã‚å‰</div>
<div class="view-btn" data-view="left-back">å·¦æ–œã‚å¾Œ</div>
<div class="view-btn" data-view="right-back">å³æ–œã‚å¾Œ</div>
</div>
<div class="canvas-container" id="canvasContainer">
<div class="head-illustration" id="headIllustration"></div>
<canvas id="drawingCanvas"></canvas>
</div>
<div class="action-buttons">
<button class="btn btn-primary" id="saveBtn">ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ä¿å­˜</button>
<button class="btn btn-secondary" id="loadBtn">ğŸ“‚ ãƒ‡ãƒ¼ã‚¿èª­è¾¼</button>
<button class="btn btn-secondary" id="newBtn">ğŸ‘¤ æ–°è¦é¡§å®¢</button>
</div>
<input type="file" id="loadFile" accept=".json" style="display: none;">
</div>
</div>
</div>
</div>

<div class="status-indicator" id="statusIndicator"></div>

<div id="passwordModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: none; align-items: center; justify-content: center;">
<div style="background: white; padding: 40px; border-radius: 20px; max-width: 400px; width: 90%;">
<h2 style="margin-bottom: 20px; text-align: center;">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®šã—ã¦ãã ã•ã„</h2>
<p style="color: #666; margin-bottom: 20px; font-size: 14px;">åˆå›èµ·å‹•æ™‚ã®ã¿ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®šã—ã¾ã™ã€‚</p>
<input type="password" id="setPassword" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆ8æ–‡å­—ä»¥ä¸Šï¼‰" style="width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 10px; font-size: 16px; margin-bottom: 15px;">
<input type="password" id="confirmPassword" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèª" style="width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 10px; font-size: 16px; margin-bottom: 20px;">
<button onclick="setPasswordFunc()" style="width: 100%; padding: 15px; background: #667eea; color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 700; cursor: pointer;">è¨­å®šã™ã‚‹</button>
</div>
</div>

<div id="loginModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: none; align-items: center; justify-content: center;">
<div style="background: white; padding: 40px; border-radius: 20px; max-width: 400px; width: 90%;">
<h2 style="margin-bottom: 20px; text-align: center;">ãƒ­ã‚°ã‚¤ãƒ³</h2>
<input type="password" id="loginPassword" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›" style="width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 10px; font-size: 16px; margin-bottom: 20px;">
<button onclick="loginFunc()" style="width: 100%; padding: 15px; background: #667eea; color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 700; cursor: pointer;">ãƒ­ã‚°ã‚¤ãƒ³</button>
<p id="loginError" style="color: #e74c3c; margin-top: 15px; text-align: center; display: none;">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™</p>
</div>
</div>

<script>
// ========================================
// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
// ========================================
let canvas, ctx;
let isDrawing = false;
let currentTool = 'pen';
let currentColor = '#000';
let currentSize = 3;
let currentView = 'front';
let lastX = 0, lastY = 0;
let canvasData = {};
let undoStack = [];
let redoStack = [];
let customerDatabase = [];

// ========================================
// åˆæœŸåŒ–é–¢æ•°
// ========================================
function init() {
    checkPassword();
    initCanvas();
    setupAllEvents();
    generateCustomerId();
    setTodayDate();
    showHeadIllustration();
    loadCustomerDatabase();
    displayCustomerList();
}

function checkPassword() {
    const savedHash = localStorage.getItem('appPasswordHash');
    if (!savedHash) {
        document.getElementById('passwordModal').style.display = 'flex';
    } else {
        document.getElementById('loginModal').style.display = 'flex';
    }
}

function setPasswordFunc() {
    const pass = document.getElementById('setPassword').value;
    const confirm = document.getElementById('confirmPassword').value;
    if (pass.length < 8) { alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯8æ–‡å­—ä»¥ä¸Šã«ã—ã¦ãã ã•ã„'); return; }
    if (pass !== confirm) { alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“'); return; }
    localStorage.setItem('appPasswordHash', btoa(pass + 'salon-chart-salt'));
    document.getElementById('passwordModal').style.display = 'none';
    showStatus('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®šã—ã¾ã—ãŸ');
}

function loginFunc() {
    const pass = document.getElementById('loginPassword').value;
    const savedHash = localStorage.getItem('appPasswordHash');
    const hash = btoa(pass + 'salon-chart-salt');
    if (hash === savedHash) {
        document.getElementById('loginModal').style.display = 'none';
        showStatus('ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸ');
    } else {
        document.getElementById('loginError').style.display = 'block';
    }
}

function initCanvas() {
    canvas = document.getElementById('drawingCanvas');
    ctx = canvas.getContext('2d');
    const container = document.getElementById('canvasContainer');
    canvas.width = container.offsetWidth;
    canvas.height = container.offsetHeight;
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
}
<!-- ãƒ‘ãƒ¼ãƒˆ3ã¯ã“ã“ã¾ã§ã€‚ç¶šãã¾ã™... -->

// ========================================
// ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
// ========================================
function setupAllEvents() {
    // ã‚­ãƒ£ãƒ³ãƒã‚¹æç”»ã‚¤ãƒ™ãƒ³ãƒˆ
    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('mouseout', stopDrawing);
    canvas.addEventListener('touchstart', handleTouchStart, { passive: false });
    canvas.addEventListener('touchmove', handleTouchMove, { passive: false });
    canvas.addEventListener('touchend', stopDrawing, { passive: false });

    // ãƒ„ãƒ¼ãƒ«åˆ‡ã‚Šæ›¿ãˆ
    document.getElementById('penTool').onclick = () => { currentTool = 'pen'; document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active')); document.getElementById('penTool').classList.add('active'); };
    document.getElementById('eraserTool').onclick = () => { currentTool = 'eraser'; document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active')); document.getElementById('eraserTool').classList.add('active'); };
    
    // è‰²é¸æŠ
    document.querySelectorAll('.color-btn').forEach(btn => {
        btn.onclick = function() { currentColor = this.dataset.color; document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active')); this.classList.add('active'); };
    });

    // ãƒ–ãƒ©ã‚·ã‚µã‚¤ã‚º
    document.getElementById('brushSize').oninput = function() { currentSize = parseInt(this.value); document.getElementById('sizeDisplay').textContent = this.value + 'px'; };

    // è¦–ç‚¹åˆ‡ã‚Šæ›¿ãˆ
    document.querySelectorAll('.view-btn').forEach(btn => {
        btn.onclick = function() { saveCurrentView(); currentView = this.dataset.view; document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active')); this.classList.add('active'); loadCurrentView(); showHeadIllustration(); undoStack = []; redoStack = []; };
    });

    // Undo/Redo
    document.getElementById('undoBtn').onclick = undo;
    document.getElementById('redoBtn').onclick = redo;

    // ãƒ‡ãƒ¼ã‚¿æ“ä½œ
    document.getElementById('saveBtn').onclick = saveData;
    document.getElementById('loadBtn').onclick = () => document.getElementById('loadFile').click();
    document.getElementById('loadFile').onchange = loadData;
    document.getElementById('newBtn').onclick = newCustomer;

    // é¡§å®¢æ¤œç´¢
    document.getElementById('customerSearch').oninput = function() { displayCustomerList(this.value); };

    // LINEé€£æº
    document.getElementById('lineId').oninput = checkLineIdInput;
    document.getElementById('sendLineBtn').onclick = sendLineMessage;
}

// ========================================
// æç”»æ©Ÿèƒ½
// ========================================
function startDrawing(e) {
    isDrawing = true;
    const pos = getPosition(e);
    lastX = pos.x;
    lastY = pos.y;
    saveUndo();
    redoStack = [];
}

function draw(e) {
    if (!isDrawing) return;
    const pos = getPosition(e);
    ctx.globalCompositeOperation = currentTool === 'eraser' ? 'destination-out' : 'source-over';
    ctx.strokeStyle = currentColor;
    ctx.lineWidth = currentSize;
    ctx.beginPath();
    ctx.moveTo(lastX, lastY);
    ctx.lineTo(pos.x, pos.y);
    ctx.stroke();
    lastX = pos.x;
    lastY = pos.y;
}

function stopDrawing() {
    if (isDrawing) {
        isDrawing = false;
        saveCurrentView();
    }
}

function handleTouchStart(e) {
    e.preventDefault();
    if (e.touches && e.touches.length > 0) {
        const touch = e.touches[0];
        isDrawing = true;
        const pos = getPosition(touch);
        lastX = pos.x;
        lastY = pos.y;
        saveUndo();
        redoStack = [];
    }
}

function handleTouchMove(e) {
    e.preventDefault();
    if (!isDrawing || !e.touches || !e.touches[0]) return;
    const touch = e.touches[0];
    const pos = getPosition(touch);
    ctx.globalCompositeOperation = currentTool === 'eraser' ? 'destination-out' : 'source-over';
    ctx.strokeStyle = currentColor;
    ctx.lineWidth = currentSize;
    ctx.beginPath();
    ctx.moveTo(lastX, lastY);
    ctx.lineTo(pos.x, pos.y);
    ctx.stroke();
    lastX = pos.x;
    lastY = pos.y;
}

function getPosition(e) {
    const rect = canvas.getBoundingClientRect();
    return { x: (e.clientX || e.pageX) - rect.left, y: (e.clientY || e.pageY) - rect.top };
}

// ========================================
// é ­éƒ¨ã‚¤ãƒ©ã‚¹ãƒˆè¡¨ç¤º
// ========================================
function showHeadIllustration() {
    const ill = document.getElementById('headIllustration');
    const svgs = {
        'front': '<svg width="100%" height="100%" viewBox="0 0 400 500"><ellipse cx="200" cy="250" rx="100" ry="150" fill="none" stroke="#ddd" stroke-width="2"/><circle cx="170" cy="210" r="10" fill="none" stroke="#ddd" stroke-width="2"/><circle cx="230" cy="210" r="10" fill="none" stroke="#ddd" stroke-width="2"/><path d="M180 250 Q200 265 220 250" fill="none" stroke="#ddd" stroke-width="2"/><path d="M150 150 Q200 130 250 150" fill="none" stroke="#ddd" stroke-width="2"/><text x="200" y="480" text-anchor="middle" font-size="14" fill="#999">æ­£é¢</text></svg>',
        'back': '<svg width="100%" height="100%" viewBox="0 0 400 500"><ellipse cx="200" cy="250" rx="100" ry="150" fill="none" stroke="#ddd" stroke-width="2"/><path d="M130 180 Q200 150 270 180" fill="none" stroke="#ddd" stroke-width="2"/><path d="M140 200 Q200 175 260 200" fill="none" stroke="#ddd" stroke-width="2"/><text x="200" y="480" text-anchor="middle" font-size="14" fill="#999">èƒŒé¢</text></svg>',
        'left': '<svg width="100%" height="100%" viewBox="0 0 400 500"><ellipse cx="200" cy="250" rx="80" ry="150" fill="none" stroke="#ddd" stroke-width="2"/><circle cx="230" cy="210" r="10" fill="none" stroke="#ddd" stroke-width="2"/><path d="M220 250 Q230 265 240 250" fill="none" stroke="#ddd" stroke-width="2"/><path d="M165 160 Q200 145 235 160" fill="none" stroke="#ddd" stroke-width="2"/><text x="200" y="480" text-anchor="middle" font-size="14" fill="#999">å·¦å´é¢</text></svg>',
        'right': '<svg width="100%" height="100%" viewBox="0 0 400 500"><ellipse cx="200" cy="250" rx="80" ry="150" fill="none" stroke="#ddd" stroke-width="2"/><circle cx="170" cy="210" r="10" fill="none" stroke="#ddd" stroke-width="2"/><path d="M160 250 Q170 265 180 250" fill="none" stroke="#ddd" stroke-width="2"/><path d="M165 160 Q200 145 235 160" fill="none" stroke="#ddd" stroke-width="2"/><text x="200" y="480" text-anchor="middle" font-size="14" fill="#999">å³å´é¢</text></svg>',
        'left-front': '<svg width="100%" height="100%" viewBox="0 0 400 500"><ellipse cx="200" cy="250" rx="90" ry="150" fill="none" stroke="#ddd" stroke-width="2"/><circle cx="220" cy="210" r="10" fill="none" stroke="#ddd" stroke-width="2"/><circle cx="175" cy="215" r="8" fill="none" stroke="#ddd" stroke-width="1.5"/><path d="M200 250 Q215 265 230 250" fill="none" stroke="#ddd" stroke-width="2"/><path d="M155 155 Q200 135 245 155" fill="none" stroke="#ddd" stroke-width="2"/><text x="200" y="480" text-anchor="middle" font-size="14" fill="#999">å·¦æ–œã‚å‰</text></svg>',
        'right-front': '<svg width="100%" height="100%" viewBox="0 0 400 500"><ellipse cx="200" cy="250" rx="90" ry="150" fill="none" stroke="#ddd" stroke-width="2"/><circle cx="180" cy="210" r="10" fill="none" stroke="#ddd" stroke-width="2"/><circle cx="225" cy="215" r="8" fill="none" stroke="#ddd" stroke-width="1.5"/><path d="M170 250 Q185 265 200 250" fill="none" stroke="#ddd" stroke-width="2"/><path d="M155 155 Q200 135 245 155" fill="none" stroke="#ddd" stroke-width="2"/><text x="200" y="480" text-anchor="middle" font-size="14" fill="#999">å³æ–œã‚å‰</text></svg>',
        'left-back': '<svg width="100%" height="100%" viewBox="0 0 400 500"><ellipse cx="200" cy="250" rx="90" ry="150" fill="none" stroke="#ddd" stroke-width="2"/><path d="M135 180 Q200 155 265 180" fill="none" stroke="#ddd" stroke-width="2"/><path d="M145 200 Q200 180 255 200" fill="none" stroke="#ddd" stroke-width="2"/><text x="200" y="480" text-anchor="middle" font-size="14" fill="#999">å·¦æ–œã‚å¾Œ</text></svg>',
        'right-back': '<svg width="100%" height="100%" viewBox="0 0 400 500"><ellipse cx="200" cy="250" rx="90" ry="150" fill="none" stroke="#ddd" stroke-width="2"/><path d="M135 180 Q200 155 265 180" fill="none" stroke="#ddd" stroke-width="2"/><path d="M145 200 Q200 180 255 200" fill="none" stroke="#ddd" stroke-width="2"/><text x="200" y="480" text-anchor="middle" font-size="14" fill="#999">å³æ–œã‚å¾Œ</text></svg>'
    };
    ill.innerHTML = svgs[currentView] || svgs['front'];
}

// ========================================
// ã‚­ãƒ£ãƒ³ãƒã‚¹ç®¡ç†
// ========================================
function saveCurrentView() { canvasData[currentView] = canvas.toDataURL(); }
function loadCurrentView() { ctx.clearRect(0, 0, canvas.width, canvas.height); if (canvasData[currentView]) { const img = new Image(); img.onload = () => ctx.drawImage(img, 0, 0); img.src = canvasData[currentView]; } }
function saveUndo() { undoStack.push(canvas.toDataURL()); if (undoStack.length > 100) undoStack.shift(); }
function undo() { if (undoStack.length > 0) { redoStack.push(canvas.toDataURL()); const data = undoStack.pop(); const img = new Image(); img.onload = () => { ctx.clearRect(0, 0, canvas.width, canvas.height); ctx.drawImage(img, 0, 0); saveCurrentView(); }; img.src = data; showStatus('å‰ã«æˆ»ã‚Šã¾ã—ãŸ (' + undoStack.length + 'å›åˆ†)'); } else { showStatus('ã“ã‚Œä»¥ä¸Šæˆ»ã‚Œã¾ã›ã‚“'); } }
function redo() { if (redoStack.length > 0) { const data = redoStack.pop(); undoStack.push(canvas.toDataURL()); const img = new Image(); img.onload = () => { ctx.clearRect(0, 0, canvas.width, canvas.height); ctx.drawImage(img, 0, 0); saveCurrentView(); }; img.src = data; showStatus('æ¬¡ã¸é€²ã¿ã¾ã—ãŸ'); } else { showStatus('ã“ã‚Œä»¥ä¸Šé€²ã‚ã¾ã›ã‚“'); } }

// ========================================
// LINEé€£æºæ©Ÿèƒ½
// ========================================
function checkLineIdInput() {
    const lineId = document.getElementById('lineId').value.trim();
    const btn = document.getElementById('sendLineBtn');
    btn.disabled = !lineId;
}

function sendLineMessage() {
    const lineId = document.getElementById('lineId').value.trim();
    const customerName = document.getElementById('customerName').value;
    
    if (!lineId) {
        showStatus('LINE IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
    }
    
    // LINEã‚¢ãƒ—ãƒªã‚’é–‹ãï¼ˆ@ä»˜ãIDã®å ´åˆï¼‰
    if (lineId.startsWith('@')) {
        window.location.href = 'line://ti/p/' + lineId;
    } else {
        window.location.href = 'line://ti/p/@' + lineId;
    }
    
    showStatus(customerName ? customerName + 'æ§˜ã®LINEã‚’é–‹ãã¾ã—ãŸ' : 'LINEã‚’é–‹ãã¾ã—ãŸ');
}

// ========================================
// ãƒ‡ãƒ¼ã‚¿ç®¡ç†æ©Ÿèƒ½
// ========================================
function saveData() {
    const name = document.getElementById('customerName').value;
    if (!name) { showStatus('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
    saveCurrentView();
    const allData = {
        customerId: document.getElementById('customerId').value,
        customerName: name,
        customerAge: document.getElementById('customerAge').value,
        visitDate: document.getElementById('visitDate').value,
        stylistName: document.getElementById('stylistName').value,
        lineId: document.getElementById('lineId').value,
        canvasData: canvasData,
        timestamp: new Date().toISOString()
    };
    const existingIndex = customerDatabase.findIndex(c => c.customerId === allData.customerId);
    if (existingIndex >= 0) { customerDatabase[existingIndex] = allData; } else { customerDatabase.push(allData); }
    saveCustomerDatabase();
    displayCustomerList();
    const dataStr = JSON.stringify(allData, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = 'ã‚«ãƒ«ãƒ†_' + name + '_' + allData.customerId + '.json';
    link.click();
    URL.revokeObjectURL(url);
    showStatus('ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
}

function loadData(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(event) {
        try {
            const data = JSON.parse(event.target.result);
            loadCustomerData(data);
            showStatus('ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
        } catch (error) {
            showStatus('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
    };
    reader.readAsText(file);
    e.target.value = '';
}

function loadCustomerData(data) {
    document.getElementById('customerId').value = data.customerId || '';
    document.getElementById('customerName').value = data.customerName || '';
    document.getElementById('customerAge').value = data.customerAge || '';
    document.getElementById('visitDate').value = data.visitDate || '';
    document.getElementById('stylistName').value = data.stylistName || '';
    document.getElementById('lineId').value = data.lineId || '';
    canvasData = data.canvasData || {};
    loadCurrentView();
    showHeadIllustration();
    checkLineIdInput();
}

function saveCustomerDatabase() { localStorage.setItem('customerDatabase', JSON.stringify(customerDatabase)); }
function loadCustomerDatabase() { const saved = localStorage.getItem('customerDatabase'); if (saved) { customerDatabase = JSON.parse(saved); } }

function displayCustomerList(searchTerm = '') {
    const listContainer = document.getElementById('customerList');
    if (customerDatabase.length === 0) { listContainer.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">ä¿å­˜ã•ã‚ŒãŸé¡§å®¢ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“</div>'; return; }
    const filtered = customerDatabase.filter(c => !searchTerm || c.customerName.includes(searchTerm) || c.customerId.includes(searchTerm));
    if (filtered.length === 0) { listContainer.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">è©²å½“ã™ã‚‹é¡§å®¢ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>'; return; }
    listContainer.innerHTML = filtered.map(customer => '<div onclick=\'loadCustomerFromList(' + JSON.stringify(customer).replace(/'/g, "&apos;") + ')\' style="padding: 15px; border: 2px solid #ddd; border-radius: 10px; margin-bottom: 10px; cursor: pointer; background: white;"><div style="font-weight: 700; font-size: 16px; color: #2d3436; margin-bottom: 5px;">' + customer.customerName + (customer.lineId ? ' ğŸ“±' : '') + '</div><div style="font-size: 13px; color: #636e72;">ID: ' + customer.customerId + '</div><div style="font-size: 13px; color: #636e72;">æ¥åº—æ—¥: ' + (customer.visitDate || 'æœªè¨­å®š') + '</div></div>').join('');
}

function loadCustomerFromList(customerData) { loadCustomerData(customerData); showStatus(customerData.customerName + 'æ§˜ã®ã‚«ãƒ«ãƒ†ã‚’é–‹ãã¾ã—ãŸ'); }

function newCustomer() {
    if (!confirm('æ–°è¦é¡§å®¢ã‚’ä½œæˆã—ã¾ã™ã‹ï¼Ÿ')) return;
    document.querySelectorAll('input[type="text"], input[type="number"]').forEach(input => { if (input.id !== 'customerId') input.value = ''; });
    canvasData = {}; undoStack = []; redoStack = [];
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    generateCustomerId(); setTodayDate(); showHeadIllustration();
    checkLineIdInput();
    showStatus('æ–°è¦é¡§å®¢ã‚’ä½œæˆã—ã¾ã—ãŸ');
}

function generateCustomerId() {
    const now = new Date();
    const id = 'C' + now.getFullYear().toString().slice(-2) + String(now.getMonth() + 1).padStart(2, '0') + String(now.getDate()).padStart(2, '0') + String(now.getHours()).padStart(2, '0') + String(now.getMinutes()).padStart(2, '0') + Math.random().toString(36).substr(2, 3).toUpperCase();
    document.getElementById('customerId').value = id;
}

function setTodayDate() { document.getElementById('visitDate').value = new Date().toISOString().split('T')[0]; }
function showStatus(msg) { const status = document.getElementById('statusIndicator'); status.textContent = msg; status.classList.add('show'); setTimeout(() => status.classList.remove('show'), 2500); }

window.addEventListener('load', init);
window.addEventListener('resize', () => {
    const container = document.getElementById('canvasContainer');
    const oldData = canvas.toDataURL();
    canvas.width = container.offsetWidth;
    canvas.height = container.offsetHeight;
    const img = new Image();
    img.onload = () => ctx.drawImage(img, 0, 0);
    img.src = oldData;
});
</script>
</body>
</html>
