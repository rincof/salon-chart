<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>美容室カルテシステム - 来店履歴対応版</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f5f5;
            padding: 10px;
            touch-action: pan-y;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
            font-size: 24px;
        }
        .section {
            margin-bottom: 30px;
        }
        .section h2 {
            color: #555;
            font-size: 18px;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #007AFF;
        }
        .customer-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .form-group {
            display: flex;
            flex-direction: column;
        }
        label {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }
        input, textarea, select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        textarea {
            resize: vertical;
            min-height: 60px;
        }
        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
        }
        .menu-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .menu-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }
        .view-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        .view-btn {
            padding: 8px 16px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        .view-btn:hover {
            background: #f0f0f0;
        }
        .view-btn.active {
            background: #007AFF;
            color: white;
            border-color: #007AFF;
        }
        #drawingCanvas {
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            cursor: crosshair;
            display: block;
            width: 100%;
            max-width: 800px;
            height: 400px;
            touch-action: none;
        }
        .drawing-tools {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        .tool-btn, .save-btn, .back-btn {
            padding: 8px 16px;
            background: #007AFF;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .tool-btn:hover, .save-btn:hover, .back-btn:hover {
            background: #0056b3;
        }
        .line-btn {
            padding: 8px 16px;
            background: #06C755;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        .line-btn:hover {
            background: #05b34a;
        }
        .line-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .delete-btn {
            padding: 8px 16px;
            background: #ff3b30;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .delete-btn:hover {
            background: #cc2e24;
        }
        .color-picker {
            display: flex;
            gap: 5px;
            align-items: center;
        }
        .color-btn {
            width: 30px;
            height: 30px;
            border: 2px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
        }
        .color-btn.active {
            border-color: #007AFF;
            box-shadow: 0 0 0 2px #007AFF;
        }
        input[type="color"] {
            width: 40px;
            height: 30px;
            border: none;
            cursor: pointer;
        }
        .size-control {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        input[type="range"] {
            width: 100px;
        }
        .customer-item {
            padding: 15px;
            background: #f9f9f9;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #e0e0e0;
        }
        .customer-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .customer-name {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }
.customer-stats {
            display: flex;
            gap: 15px;
            font-size: 14px;
            color: #666;
            margin-top: 8px;
        }
        .customer-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        .small-btn {
            padding: 6px 12px;
            font-size: 13px;
            background: #007AFF;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .small-btn:hover {
            background: #0056b3;
        }
        .small-btn.secondary {
            background: #5856D6;
        }
        .small-btn.secondary:hover {
            background: #4644b0;
        }
        .visit-item {
            padding: 12px;
            background: white;
            border-radius: 6px;
            margin-bottom: 10px;
            border: 1px solid #e0e0e0;
            cursor: pointer;
            transition: all 0.2s;
        }
        .visit-item:hover {
            background: #f0f8ff;
            border-color: #007AFF;
        }
        .visit-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .visit-date {
            font-weight: bold;
            color: #333;
            font-size: 16px;
        }
        .visit-price {
            color: #007AFF;
            font-weight: bold;
            font-size: 16px;
        }
        .visit-details {
            font-size: 14px;
            color: #666;
        }
        .search-box {
            margin-bottom: 15px;
        }
        .search-box input {
            width: 100%;
        }
        .file-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        .upload-area {
            border: 2px dashed #ddd;
            border-radius: 4px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            margin-bottom: 10px;
        }
        .upload-area:hover {
            border-color: #007AFF;
            background: #f0f8ff;
        }
        .current-image {
            max-width: 200px;
            margin-top: 10px;
            border-radius: 4px;
        }
        .hair-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .section-parts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .photo-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .photo-box {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            background: #fafafa;
        }
        .photo-box h3 {
            font-size: 16px;
            color: #555;
            margin-bottom: 10px;
        }
        .photo-preview {
            width: 100%;
            max-width: 300px;
            height: 200px;
            border: 1px solid #ddd;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            margin: 10px auto;
            overflow: hidden;
        }
        .photo-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        .photo-preview-empty {
            color: #999;
            font-size: 14px;
        }
        .photo-upload-btn {
            padding: 8px 16px;
            background: #007AFF;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        .photo-upload-btn:hover {
            background: #0056b3;
        }
        .photo-delete-btn {
            padding: 6px 12px;
            background: #ff3b30;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 5px;
        }
        .photo-delete-btn:hover {
            background: #cc2e24;
        }
        .screen {
            display: none;
        }
        .screen.active {
            display: block;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 8px;
            color: white;
        }
        .stat-box.green {
            background: linear-gradient(135deg, #06C755 0%, #05b34a 100%);
        }
        .stat-box.orange {
            background: linear-gradient(135deg, #FF9500 0%, #FF6B00 100%);
        }
        .stat-box.blue {
            background: linear-gradient(135deg, #007AFF 0%, #0056b3 100%);
        }
        .stat-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 5px;
        }
        .stat-value {
            font-size: 28px;
            font-weight: bold;
        }
        .menu-analysis {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        .menu-analysis-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e0e0e0;
        }
        .menu-analysis-item:last-child {
            border-bottom: none;
        }
        @media (max-width: 768px) {
            .customer-info {
                grid-template-columns: 1fr;
            }
            .menu-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }
            .drawing-tools {
                flex-direction: column;
                align-items: stretch;
            }
            .tool-btn {
                width: 100%;
            }
            .photo-section {
                grid-template-columns: 1fr;
            }
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
<div class="container">
        <h1>美容室カルテシステム（来店履歴対応版）</h1>
        
        <div id="customerListScreen" class="screen active">
            <div class="section">
                <h2>顧客一覧</h2>
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="顧客名、電話番号、LINE IDで検索..." oninput="searchCustomers()">
                </div>
                <button class="save-btn" onclick="showNewCustomerForm()">➕ 新規顧客登録</button>
                <div id="customerList" style="margin-top: 20px;"></div>
            </div>
        </div>
        
        <div id="customerDetailScreen" class="screen">
            <button class="back-btn" onclick="showCustomerList()">◀ 顧客一覧に戻る</button>
            
            <div class="section">
                <h2 id="customerDetailName">顧客詳細</h2>
                <div class="customer-info">
                    <div class="form-group">
                        <label>電話番号</label>
                        <input type="tel" id="detailPhone" readonly>
                    </div>
                    <div class="form-group">
                        <label>LINE ID</label>
                        <input type="text" id="detailLineId" readonly>
                    </div>
                </div>
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <button class="line-btn" onclick="openLineFromDetail()" id="detailLineBtn" disabled>
                        💬 LINEでメッセージを送る
                    </button>
                    <button class="save-btn" onclick="editCustomerInfo()">✏️ 顧客情報を編集</button>
                </div>
                
                <div class="stats-grid" id="customerStats"></div>
                <div class="menu-analysis" id="menuAnalysis"></div>
            </div>
            
            <div class="section">
                <h2>来店履歴</h2>
                <button class="save-btn" onclick="showNewVisitForm()">➕ 新規来店記録を追加</button>
                <div id="visitList" style="margin-top: 20px;"></div>
            </div>
        </div>
        
        <div id="chartScreen" class="screen">
            <button class="back-btn" onclick="backToCustomerDetail()">◀ 来店履歴に戻る</button>
            
            <div class="section">
                <h2 id="chartTitle">カルテ</h2>
                <div class="customer-info">
                    <div class="form-group">
                        <label>顧客名</label>
                        <input type="text" id="chartCustomerName" readonly>
                    </div>
                    <div class="form-group">
                        <label>担当者</label>
                        <input type="text" id="staffName" placeholder="スタイリスト名">
                    </div>
                    <div class="form-group">
                        <label>来店日</label>
                        <input type="date" id="visitDate">
                    </div>
                    <div class="form-group">
                        <label>価格</label>
                        <input type="number" id="price" placeholder="10000">
                    </div>
                </div>
            </div>

            <div class="section">
                <h2>📸 ビフォー・アフター写真</h2>
                <div class="photo-section">
                    <div class="photo-box">
                        <h3>ビフォー写真</h3>
                        <div class="photo-preview" id="beforePreview">
                            <span class="photo-preview-empty">写真未登録</span>
                        </div>
                        <button class="photo-upload-btn" onclick="document.getElementById('beforePhoto').click()">
                            📷 写真をアップロード
                        </button>
                        <input type="file" id="beforePhoto" accept="image/*" style="display:none" onchange="uploadPhoto(event, 'before')">
                        <button class="photo-delete-btn" onclick="deletePhoto('before')" id="beforeDeleteBtn" style="display:none">
                            🗑️ 削除
                        </button>
                    </div>
                    <div class="photo-box">
                        <h3>アフター写真</h3>
                        <div class="photo-preview" id="afterPreview">
                            <span class="photo-preview-empty">写真未登録</span>
                        </div>
                        <button class="photo-upload-btn" onclick="document.getElementById('afterPhoto').click()">
                            📷 写真をアップロード
                        </button>
                        <input type="file" id="afterPhoto" accept="image/*" style="display:none" onchange="uploadPhoto(event, 'after')">
                        <button class="photo-delete-btn" onclick="deletePhoto('after')" id="afterDeleteBtn" style="display:none">
                            🗑️ 削除
                        </button>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2>施術メニュー</h2>
                <div class="menu-grid">
                    <div class="menu-item"><input type="checkbox" id="menu_cut"><label for="menu_cut">カット</label></div>
                    <div class="menu-item"><input type="checkbox" id="menu_color"><label for="menu_color">カラー</label></div>
                    <div class="menu-item"><input type="checkbox" id="menu_perm"><label for="menu_perm">パーマ</label></div>
                    <div class="menu-item"><input type="checkbox" id="menu_treatment"><label for="menu_treatment">トリートメント</label></div>
                    <div class="menu-item"><input type="checkbox" id="menu_head_spa"><label for="menu_head_spa">ヘッドスパ</label></div>
                    <div class="menu-item"><input type="checkbox" id="menu_straightening"><label for="menu_straightening">縮毛矯正</label></div>
                </div>
            </div>
            
            <div class="section">
                <h2>ヘアスタイル設計図</h2>
                <div class="upload-area" onclick="document.getElementById('imageUpload').click()">
                    <p>カスタムイラストをアップロード（クリック）</p>
                    <input type="file" id="imageUpload" accept="image/*" style="display:none" onchange="uploadCustomImage(event)">
                    <img id="currentImage" class="current-image" style="display:none">
                </div>
                <div class="view-selector">
                    <button class="view-btn active" onclick="changeView('front')">正面</button>
                    <button class="view-btn" onclick="changeView('back')">背面</button>
                    <button class="view-btn" onclick="changeView('left')">左側面</button>
                    <button class="view-btn" onclick="changeView('right')">右側面</button>
                    <button class="view-btn" onclick="changeView('left-front')">左斜め前</button>
                    <button class="view-btn" onclick="changeView('right-front')">右斜め前</button>
                    <button class="view-btn" onclick="changeView('left-back')">左斜め後</button>
                    <button class="view-btn" onclick="changeView('right-back')">右斜め後</button>
                </div>
                <div class="drawing-tools">
                    <div class="color-picker">
                        <button class="color-btn active" style="background: black" onclick="selectColor('black')"></button>
                        <button class="color-btn" style="background: red" onclick="selectColor('red')"></button>
                        <button class="color-btn" style="background: blue" onclick="selectColor('blue')"></button>
                        <button class="color-btn" style="background: green" onclick="selectColor('green')"></button>
                        <input type="color" id="customColor" value="#000000" onchange="selectColor(this.value)">
                    </div>
                    <div class="size-control">
                        <label>太さ:</label>
                        <input type="range" id="brushSize" min="1" max="20" value="2" oninput="updateBrushSize(this.value)">
                        <span id="sizeDisplay">2px</span>
                    </div>
                    <button class="tool-btn" onclick="undo()">元に戻す</button>
                    <button class="tool-btn" onclick="redo()">やり直し</button>
                    <button class="tool-btn" onclick="clearCanvas()">クリア</button>
                </div>
                <div class="canvas-container">
                    <canvas id="drawingCanvas"></canvas>
                </div>
            </div>
<div class="section">
                <h2>髪型詳細</h2>
                <div class="hair-details">
                    <div class="form-group">
                        <label>レングス</label>
                        <select id="length">
                            <option>ショート</option>
                            <option>ミディアム</option>
                            <option>ロング</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>カットスタイル</label>
                        <input type="text" id="cutStyle" placeholder="例: レイヤー">
                    </div>
                    <div class="form-group">
                        <label>カラー</label>
                        <input type="text" id="hairColor" placeholder="例: アッシュブラウン">
                    </div>
                    <div class="form-group">
                        <label>カラーレベル</label>
                        <input type="text" id="colorLevel" placeholder="例: 8トーン">
                    </div>
                    <div class="form-group">
                        <label>パーマ種類</label>
                        <input type="text" id="permType" placeholder="例: デジタルパーマ">
                    </div>
                    <div class="form-group">
                        <label>ロッドサイズ</label>
                        <input type="text" id="rodSize" placeholder="例: 14mm">
                    </div>
                    <div class="form-group">
                        <label>前髪</label>
                        <input type="text" id="bangs" placeholder="例: シースルーバング">
                    </div>
                    <div class="form-group">
                        <label>顔周り</label>
                        <input type="text" id="faceFrame" placeholder="例: レイヤー強め">
                    </div>
                    <div class="form-group">
                        <label>毛量調整</label>
                        <input type="text" id="volume" placeholder="例: 軽め">
                    </div>
                    <div class="form-group">
                        <label>その他技術</label>
                        <input type="text" id="otherTech" placeholder="例: ハイライト">
                    </div>
                </div>
                <h3 style="margin-top: 25px; margin-bottom: 15px; color: #555; font-size: 16px;">部位別詳細</h3>
                <div class="section-parts">
                    <div class="form-group">
                        <label>前髪</label>
                        <input type="text" id="part_bangs" placeholder="長さ・スタイル">
                    </div>
                    <div class="form-group">
                        <label>フロント</label>
                        <input type="text" id="part_front" placeholder="長さ・スタイル">
                    </div>
                    <div class="form-group">
                        <label>トップ</label>
                        <input type="text" id="part_top" placeholder="長さ・スタイル">
                    </div>
                    <div class="form-group">
                        <label>クラウン</label>
                        <input type="text" id="part_crown" placeholder="長さ・スタイル">
                    </div>
                    <div class="form-group">
                        <label>バック</label>
                        <input type="text" id="part_back" placeholder="長さ・スタイル">
                    </div>
                    <div class="form-group">
                        <label>ネープ</label>
                        <input type="text" id="part_nape" placeholder="長さ・スタイル">
                    </div>
                    <div class="form-group">
                        <label>サイド上</label>
                        <input type="text" id="part_side_upper" placeholder="長さ・スタイル">
                    </div>
                    <div class="form-group">
                        <label>サイド下</label>
                        <input type="text" id="part_side_lower" placeholder="長さ・スタイル">
                    </div>
                    <div class="form-group">
                        <label>バックサイド上</label>
                        <input type="text" id="part_backside_upper" placeholder="長さ・スタイル">
                    </div>
                    <div class="form-group">
                        <label>バックサイド下</label>
                        <input type="text" id="part_backside_lower" placeholder="長さ・スタイル">
                    </div>
                    <div class="form-group">
                        <label>右ネープ</label>
                        <input type="text" id="part_right_nape" placeholder="長さ・スタイル">
                    </div>
                    <div class="form-group">
                        <label>左ネープ</label>
                        <input type="text" id="part_left_nape" placeholder="長さ・スタイル">
                    </div>
                </div>
                <div class="form-group" style="margin-top: 15px;">
                    <label>備考欄</label>
                    <textarea id="notes" rows="4" placeholder="施術内容の詳細、お客様の要望、注意事項など"></textarea>
                </div>
            </div>
            
            <div class="section">
                <button class="save-btn" onclick="saveVisit()">💾 カルテを保存</button>
                <button class="delete-btn" onclick="deleteVisit()" id="deleteVisitBtn" style="display:none;">🗑️ この来店記録を削除</button>
                <div class="file-controls">
                    <button class="save-btn" onclick="exportAllData()">📦 全データをエクスポート</button>
                    <label class="save-btn" style="display: inline-block; text-align: center;">
                        📥 データをインポート
                        <input type="file" accept=".json" onchange="importAllData(event)" style="display:none">
                    </label>
                </div>
            </div>
        </div>
    </div>
    
    <script>
let canvas, ctx;
        let isDrawing = false;
        let currentColor = 'black';
        let brushSize = 2;
        let currentView = 'front';
        let drawingHistory = [];
        let historyStep = -1;
        let customImage = null;
        let beforePhoto = null;
        let afterPhoto = null;
        const viewData = {'front': '', 'back': '', 'left': '', 'right': '', 'left-front': '', 'right-front': '', 'left-back': '', 'right-back': ''};
        
        let currentCustomerId = null;
        let currentVisitId = null;
        let isNewVisit = false;
        
        let customers = [];
        let visits = [];
        
        window.addEventListener('load', function() {
            loadData();
            initCanvas();
            showCustomerList();
        });
        
        function loadData() {
            customers = JSON.parse(localStorage.getItem('salonCustomers') || '[]');
            visits = JSON.parse(localStorage.getItem('salonVisits') || '[]');
        }
        
        function saveData() {
            localStorage.setItem('salonCustomers', JSON.stringify(customers));
            localStorage.setItem('salonVisits', JSON.stringify(visits));
        }
        
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }
        
        function showCustomerList() {
            showScreen('customerListScreen');
            renderCustomerList();
        }
        
        function renderCustomerList() {
            const listDiv = document.getElementById('customerList');
            const searchQuery = document.getElementById('searchInput').value.toLowerCase();
            
            let filteredCustomers = customers;
            if (searchQuery) {
                filteredCustomers = customers.filter(c => 
                    c.name.toLowerCase().includes(searchQuery) ||
                    c.phone.includes(searchQuery) ||
                    (c.lineId && c.lineId.toLowerCase().includes(searchQuery))
                );
            }
            
            if (filteredCustomers.length === 0) {
                listDiv.innerHTML = '<p style="color: #999; text-align: center; padding: 40px;">登録された顧客がいません</p>';
                return;
            }
            
            listDiv.innerHTML = filteredCustomers.map(customer => {
                const customerVisits = visits.filter(v => v.customerId === customer.id);
                const visitCount = customerVisits.length;
                const lastVisit = customerVisits.length > 0 
                    ? customerVisits.sort((a, b) => new Date(b.visitDate) - new Date(a.visitDate))[0].visitDate 
                    : 'なし';
                const totalSales = customerVisits.reduce((sum, v) => sum + (parseInt(v.price) || 0), 0);
                
                return `
                    <div class="customer-item">
                        <div class="customer-item-header">
                            <div class="customer-name">📋 ${customer.name}</div>
                        </div>
                        <div class="customer-stats">
                            <span>📞 ${customer.phone}</span>
                            ${customer.lineId ? `<span>💬 ${customer.lineId}</span>` : ''}
                        </div>
                        <div class="customer-stats">
                            <span>来店回数: ${visitCount}回</span>
                            <span>最終来店: ${lastVisit}</span>
                            <span>累計売上: ¥${totalSales.toLocaleString()}</span>
                        </div>
                        <div class="customer-actions">
                            <button class="small-btn" onclick="showCustomerDetail(${customer.id})">📊 来店履歴を見る</button>
                            <button class="small-btn secondary" onclick="showNewVisitForm(${customer.id})">➕ 新規来店記録</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function searchCustomers() {
            renderCustomerList();
        }
        
        function showNewCustomerForm() {
            const name = prompt('顧客名を入力してください');
            if (!name) return;
            
            const phone = prompt('電話番号を入力してください（任意）') || '';
            const lineId = prompt('LINE IDを入力してください（任意）') || '';
            
            const newCustomer = {
                id: Date.now(),
                name: name,
                phone: phone,
                lineId: lineId,
                createdAt: new Date().toISOString()
            };
            
            customers.push(newCustomer);
            saveData();
            renderCustomerList();
            alert('顧客を登録しました！');
        }
        
        function showCustomerDetail(customerId) {
            currentCustomerId = customerId;
            const customer = customers.find(c => c.id === customerId);
            if (!customer) return;
            
            showScreen('customerDetailScreen');
            
            document.getElementById('customerDetailName').textContent = `${customer.name}さんの来店履歴`;
            document.getElementById('detailPhone').value = customer.phone;
            document.getElementById('detailLineId').value = customer.lineId;
            
            if (customer.lineId) {
                document.getElementById('detailLineBtn').disabled = false;
            }
            
            renderCustomerStats(customerId);
            renderVisitList(customerId);
        }
        
        function renderCustomerStats(customerId) {
            const customerVisits = visits.filter(v => v.customerId === customerId).sort((a, b) => new Date(b.visitDate) - new Date(a.visitDate));
            const visitCount = customerVisits.length;
            const totalSales = customerVisits.reduce((sum, v) => sum + (parseInt(v.price) || 0), 0);
            
            let avgInterval = 0;
            if (customerVisits.length >= 2) {
                const intervals = [];
                for (let i = 0; i < customerVisits.length - 1; i++) {
                    const date1 = new Date(customerVisits[i].visitDate);
                    const date2 = new Date(customerVisits[i + 1].visitDate);
                    const diff = Math.abs(date1 - date2) / (1000 * 60 * 60 * 24);
                    intervals.push(diff);
                }
                avgInterval = Math.round(intervals.reduce((a, b) => a + b, 0) / intervals.length);
            }
            
            let nextVisitPrediction = '';
            if (customerVisits.length >= 2 && avgInterval > 0) {
                const lastVisitDate = new Date(customerVisits[0].visitDate);
                const nextDate = new Date(lastVisitDate);
                nextDate.setDate(nextDate.getDate() + avgInterval);
                nextVisitPrediction = nextDate.toISOString().split('T')[0];
            }
            
            const menuCount = {};
            const menuNames = {
                'menu_cut': 'カット',
                'menu_color': 'カラー',
                'menu_perm': 'パーマ',
                'menu_treatment': 'トリートメント',
                'menu_head_spa': 'ヘッドスパ',
                'menu_straightening': '縮毛矯正'
            };
            
            customerVisits.forEach(visit => {
                if (visit.menus) {
                    visit.menus.forEach(menu => {
                        menuCount[menu] = (menuCount[menu] || 0) + 1;
                    });
                }
            });
document.getElementById('customerStats').innerHTML = `
                <div class="stat-box blue">
                    <div class="stat-label">来店回数</div>
                    <div class="stat-value">${visitCount}回</div>
                </div>
                <div class="stat-box green">
                    <div class="stat-label">累計売上</div>
                    <div class="stat-value">¥${totalSales.toLocaleString()}</div>
                </div>
                <div class="stat-box orange">
                    <div class="stat-label">平均来店周期</div>
                    <div class="stat-value">${avgInterval > 0 ? avgInterval + '日' : '計算中'}</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">次回来店予測</div>
                    <div class="stat-value" style="font-size: 18px;">${nextVisitPrediction || '未定'}</div>
                </div>
            `;
            
            const sortedMenus = Object.entries(menuCount).sort((a, b) => b[1] - a[1]);
            let menuAnalysisHTML = '<h3 style="margin-bottom: 10px; color: #555;">よく利用するメニュー</h3>';
            
            if (sortedMenus.length > 0) {
                menuAnalysisHTML += sortedMenus.map(([menuId, count]) => `
                    <div class="menu-analysis-item">
                        <span>${menuNames[menuId] || menuId}</span>
                        <strong>${count}回</strong>
                    </div>
                `).join('');
            } else {
                menuAnalysisHTML += '<p style="color: #999;">まだ施術データがありません</p>';
            }
            
            document.getElementById('menuAnalysis').innerHTML = menuAnalysisHTML;
        }
        
        function renderVisitList(customerId) {
            const customerVisits = visits.filter(v => v.customerId === customerId).sort((a, b) => new Date(b.visitDate) - new Date(a.visitDate));
            const listDiv = document.getElementById('visitList');
            
            if (customerVisits.length === 0) {
                listDiv.innerHTML = '<p style="color: #999; text-align: center; padding: 40px;">来店履歴がありません</p>';
                return;
            }
            
            const menuNames = {
                'menu_cut': 'カット',
                'menu_color': 'カラー',
                'menu_perm': 'パーマ',
                'menu_treatment': 'トリートメント',
                'menu_head_spa': 'ヘッドスパ',
                'menu_straightening': '縮毛矯正'
            };
            
            listDiv.innerHTML = customerVisits.map(visit => {
                const menus = visit.menus ? visit.menus.map(m => menuNames[m] || m).join('・') : 'なし';
                return `
                    <div class="visit-item" onclick="showVisitDetail(${visit.id})">
                        <div class="visit-header">
                            <div class="visit-date">📅 ${visit.visitDate}</div>
                            <div class="visit-price">¥${parseInt(visit.price || 0).toLocaleString()}</div>
                        </div>
                        <div class="visit-details">
                            担当: ${visit.staffName || '未設定'} | ${menus}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function openLineFromDetail() {
            const lineId = document.getElementById('detailLineId').value.trim();
            if (!lineId) {
                alert('LINE IDが設定されていません');
                return;
            }
            
            const lineUrl = `line://ti/p/~${lineId}`;
            window.location.href = lineUrl;
            
            setTimeout(() => {
                const webUrl = `https://line.me/ti/p/~${lineId}`;
                window.open(webUrl, '_blank');
            }, 3000);
        }
        
        function editCustomerInfo() {
            const customer = customers.find(c => c.id === currentCustomerId);
            if (!customer) return;
            
            const name = prompt('顧客名', customer.name);
            if (name) customer.name = name;
            
            const phone = prompt('電話番号', customer.phone);
            if (phone !== null) customer.phone = phone;
            
            const lineId = prompt('LINE ID', customer.lineId);
            if (lineId !== null) customer.lineId = lineId;
            
            saveData();
            showCustomerDetail(currentCustomerId);
            alert('顧客情報を更新しました');
        }
        
        function backToCustomerDetail() {
            showCustomerDetail(currentCustomerId);
        }
        
        function showNewVisitForm(customerId = null) {
            if (customerId) {
                currentCustomerId = customerId;
            }
            
            if (!currentCustomerId) {
                alert('顧客を選択してください');
                return;
            }
            
            const customer = customers.find(c => c.id === currentCustomerId);
            if (!customer) return;
            
            currentVisitId = null;
            isNewVisit = true;
            
            showScreen('chartScreen');
            document.getElementById('chartTitle').textContent = '新規来店記録';
            document.getElementById('chartCustomerName').value = customer.name;
            document.getElementById('visitDate').valueAsDate = new Date();
            document.getElementById('deleteVisitBtn').style.display = 'none';
            
            clearChartForm();
            initCanvas();
        }
        
        function showVisitDetail(visitId) {
            const visit = visits.find(v => v.id === visitId);
            if (!visit) return;
            
            currentVisitId = visitId;
            isNewVisit = false;
            
            const customer = customers.find(c => c.id === visit.customerId);
            if (!customer) return;
            
            showScreen('chartScreen');
            document.getElementById('chartTitle').textContent = `カルテ詳細 - ${visit.visitDate}`;
            document.getElementById('chartCustomerName').value = customer.name;
            document.getElementById('deleteVisitBtn').style.display = 'inline-block';
            
            loadVisitData(visit);
        }
        
        function loadVisitData(visit) {
            document.getElementById('staffName').value = visit.staffName || '';
            document.getElementById('visitDate').value = visit.visitDate;
            document.getElementById('price').value = visit.price || '';
            
            if (visit.beforePhoto) {
                beforePhoto = visit.beforePhoto;
                document.getElementById('beforePreview').innerHTML = `<img src="${visit.beforePhoto}">`;
                document.getElementById('beforeDeleteBtn').style.display = 'inline-block';
            } else {
                beforePhoto = null;
                document.getElementById('beforePreview').innerHTML = '<span class="photo-preview-empty">写真未登録</span>';
                document.getElementById('beforeDeleteBtn').style.display = 'none';
            }
            
            if (visit.afterPhoto) {
                afterPhoto = visit.afterPhoto;
                document.getElementById('afterPreview').innerHTML = `<img src="${visit.afterPhoto}">`;
                document.getElementById('afterDeleteBtn').style.display = 'inline-block';
            } else {
                afterPhoto = null;
                document.getElementById('afterPreview').innerHTML = '<span class="photo-preview-empty">写真未登録</span>';
                document.getElementById('afterDeleteBtn').style.display = 'none';
            }
            
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                cb.checked = visit.menus && visit.menus.includes(cb.id);
            });
if (visit.drawings) {
                Object.assign(viewData, visit.drawings);
            }
            
            if (visit.customImage) {
                customImage = new Image();
                customImage.src = visit.customImage;
                document.getElementById('currentImage').src = visit.customImage;
                document.getElementById('currentImage').style.display = 'block';
            }
            
            if (visit.hairDetails) {
                document.getElementById('length').value = visit.hairDetails.length || '';
                document.getElementById('cutStyle').value = visit.hairDetails.cutStyle || '';
                document.getElementById('hairColor').value = visit.hairDetails.hairColor || '';
                document.getElementById('colorLevel').value = visit.hairDetails.colorLevel || '';
                document.getElementById('permType').value = visit.hairDetails.permType || '';
                document.getElementById('rodSize').value = visit.hairDetails.rodSize || '';
                document.getElementById('bangs').value = visit.hairDetails.bangs || '';
                document.getElementById('faceFrame').value = visit.hairDetails.faceFrame || '';
                document.getElementById('volume').value = visit.hairDetails.volume || '';
                document.getElementById('otherTech').value = visit.hairDetails.otherTech || '';
                document.getElementById('notes').value = visit.hairDetails.notes || '';
            }
            
            if (visit.sectionParts) {
                document.getElementById('part_bangs').value = visit.sectionParts.bangs || '';
                document.getElementById('part_front').value = visit.sectionParts.front || '';
                document.getElementById('part_top').value = visit.sectionParts.top || '';
                document.getElementById('part_crown').value = visit.sectionParts.crown || '';
                document.getElementById('part_back').value = visit.sectionParts.back || '';
                document.getElementById('part_nape').value = visit.sectionParts.nape || '';
                document.getElementById('part_side_upper').value = visit.sectionParts.sideUpper || '';
                document.getElementById('part_side_lower').value = visit.sectionParts.sideLower || '';
                document.getElementById('part_backside_upper').value = visit.sectionParts.backsideUpper || '';
                document.getElementById('part_backside_lower').value = visit.sectionParts.backsideLower || '';
                document.getElementById('part_right_nape').value = visit.sectionParts.rightNape || '';
                document.getElementById('part_left_nape').value = visit.sectionParts.leftNape || '';
            }
            
            loadViewData();
        }
        
        function clearChartForm() {
            document.getElementById('staffName').value = '';
            document.getElementById('price').value = '';
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
            Object.keys(viewData).forEach(view => viewData[view] = '');
            drawingHistory = [];
            historyStep = -1;
            customImage = null;
            beforePhoto = null;
            afterPhoto = null;
            document.getElementById('currentImage').style.display = 'none';
            document.getElementById('beforePreview').innerHTML = '<span class="photo-preview-empty">写真未登録</span>';
            document.getElementById('afterPreview').innerHTML = '<span class="photo-preview-empty">写真未登録</span>';
            document.getElementById('beforeDeleteBtn').style.display = 'none';
            document.getElementById('afterDeleteBtn').style.display = 'none';
            document.getElementById('beforePhoto').value = '';
            document.getElementById('afterPhoto').value = '';
            document.querySelectorAll('.hair-details input, .hair-details select, #notes').forEach(el => el.value = '');
            document.querySelectorAll('.section-parts input').forEach(el => el.value = '');
            currentView = 'front';
            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector('.view-btn').classList.add('active');
        }
        
        function saveVisit() {
            saveViewData();
            
            const visitData = {
                id: currentVisitId || Date.now(),
                customerId: currentCustomerId,
                visitDate: document.getElementById('visitDate').value,
                staffName: document.getElementById('staffName').value,
                price: document.getElementById('price').value,
                beforePhoto: beforePhoto,
                afterPhoto: afterPhoto,
                menus: Array.from(document.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.id),
                drawings: {...viewData},
                customImage: customImage ? customImage.src : null,
                hairDetails: {
                    length: document.getElementById('length').value,
                    cutStyle: document.getElementById('cutStyle').value,
                    hairColor: document.getElementById('hairColor').value,
                    colorLevel: document.getElementById('colorLevel').value,
                    permType: document.getElementById('permType').value,
                    rodSize: document.getElementById('rodSize').value,
                    bangs: document.getElementById('bangs').value,
                    faceFrame: document.getElementById('faceFrame').value,
                    volume: document.getElementById('volume').value,
                    otherTech: document.getElementById('otherTech').value,
                    notes: document.getElementById('notes').value
                },
                sectionParts: {
                    bangs: document.getElementById('part_bangs').value,
                    front: document.getElementById('part_front').value,
                    top: document.getElementById('part_top').value,
                    crown: document.getElementById('part_crown').value,
                    back: document.getElementById('part_back').value,
                    nape: document.getElementById('part_nape').value,
                    sideUpper: document.getElementById('part_side_upper').value,
                    sideLower: document.getElementById('part_side_lower').value,
                    backsideUpper: document.getElementById('part_backside_upper').value,
                    backsideLower: document.getElementById('part_backside_lower').value,
                    rightNape: document.getElementById('part_right_nape').value,
                    leftNape: document.getElementById('part_left_nape').value
                }
            };
            
            if (isNewVisit) {
                visits.push(visitData);
            } else {
                const index = visits.findIndex(v => v.id === currentVisitId);
                if (index >= 0) {
                    visits[index] = visitData;
                }
            }
            
            saveData();
            alert('カルテを保存しました！');
            showCustomerDetail(currentCustomerId);
        }
        
        function deleteVisit() {
            if (!confirm('この来店記録を削除しますか？この操作は取り消せません。')) {
                return;
            }
            
            visits = visits.filter(v => v.id !== currentVisitId);
            saveData();
            alert('来店記録を削除しました');
            showCustomerDetail(currentCustomerId);
        }
        
        function exportAllData() {
            const allData = {
                customers: customers,
                visits: visits,
                exportDate: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(allData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `salon_data_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function importAllData(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const data = JSON.parse(event.target.result);
                        if (data.customers && data.visits) {
                            customers = data.customers;
                            visits = data.visits;
                            saveData();
                            alert('データを読み込みました！');
                            showCustomerList();
                        } else {
                            alert('無効なデータ形式です');
                        }
                    } catch (error) {
                        alert('ファイルの読み込みに失敗しました');
                    }
                };
                reader.readAsText(file);
            }
        }
function uploadPhoto(event, type) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageData = e.target.result;
                    
                    if (type === 'before') {
                        beforePhoto = imageData;
                        document.getElementById('beforePreview').innerHTML = `<img src="${imageData}">`;
                        document.getElementById('beforeDeleteBtn').style.display = 'inline-block';
                    } else {
                        afterPhoto = imageData;
                        document.getElementById('afterPreview').innerHTML = `<img src="${imageData}">`;
                        document.getElementById('afterDeleteBtn').style.display = 'inline-block';
                    }
                };
                reader.readAsDataURL(file);
            }
        }
        
        function deletePhoto(type) {
            if (confirm('この写真を削除しますか？')) {
                if (type === 'before') {
                    beforePhoto = null;
                    document.getElementById('beforePreview').innerHTML = '<span class="photo-preview-empty">写真未登録</span>';
                    document.getElementById('beforeDeleteBtn').style.display = 'none';
                    document.getElementById('beforePhoto').value = '';
                } else {
                    afterPhoto = null;
                    document.getElementById('afterPreview').innerHTML = '<span class="photo-preview-empty">写真未登録</span>';
                    document.getElementById('afterDeleteBtn').style.display = 'none';
                    document.getElementById('afterPhoto').value = '';
                }
            }
        }
        
        function drawBaseHeadIllustration(view) {
            ctx.strokeStyle = '#999';
            ctx.lineWidth = 2;
            ctx.fillStyle = '#f5f5f5';
            const cx = canvas.width / 2;
            const cy = canvas.height / 2;
            
            if (view === 'front') {
                ctx.beginPath();
                ctx.ellipse(cx, cy, 80, 100, 0, 0, Math.PI * 2);
                ctx.fill();
                ctx.stroke();
                ctx.beginPath();
                ctx.arc(cx - 25, cy - 30, 6, 0, Math.PI * 2);
                ctx.arc(cx + 25, cy - 30, 6, 0, Math.PI * 2);
                ctx.stroke();
                ctx.beginPath();
                ctx.arc(cx, cy + 10, 15, 0, Math.PI);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(cx - 70, cy - 90);
                ctx.quadraticCurveTo(cx - 120, cy - 50, cx - 90, cy + 20);
                ctx.moveTo(cx + 70, cy - 90);
                ctx.quadraticCurveTo(cx + 120, cy - 50, cx + 90, cy + 20);
                ctx.stroke();
            } else if (view === 'back') {
                ctx.beginPath();
                ctx.ellipse(cx, cy, 80, 100, 0, 0, Math.PI * 2);
                ctx.fill();
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(cx - 70, cy - 90);
                ctx.quadraticCurveTo(cx - 120, cy - 30, cx - 90, cy + 40);
                ctx.moveTo(cx + 70, cy - 90);
                ctx.quadraticCurveTo(cx + 120, cy - 30, cx + 90, cy + 40);
                ctx.stroke();
            } else if (view === 'left') {
                ctx.beginPath();
                ctx.ellipse(cx, cy, 60, 100, 0, 0, Math.PI * 2);
                ctx.fill();
                ctx.stroke();
                ctx.beginPath();
                ctx.arc(cx - 35, cy - 30, 6, 0, Math.PI * 2);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(cx - 50, cy - 90);
                ctx.quadraticCurveTo(cx - 90, cy - 50, cx - 80, cy + 20);
                ctx.stroke();
            } else if (view === 'right') {
                ctx.beginPath();
                ctx.ellipse(cx, cy, 60, 100, 0, 0, Math.PI * 2);
                ctx.fill();
                ctx.stroke();
                ctx.beginPath();
                ctx.arc(cx + 35, cy - 30, 6, 0, Math.PI * 2);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(cx + 50, cy - 90);
                ctx.quadraticCurveTo(cx + 90, cy - 50, cx + 80, cy + 20);
                ctx.stroke();
            } else {
                ctx.beginPath();
                ctx.ellipse(cx, cy, 70, 95, 0, 0, Math.PI * 2);
                ctx.fill();
                ctx.stroke();
            }
        }
        
        function initCanvas() {
            canvas = document.getElementById('drawingCanvas');
            ctx = canvas.getContext('2d');
            canvas.width = 800;
            canvas.height = 400;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            drawBaseHeadIllustration('front');
            saveState();
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            canvas.addEventListener('touchstart', handleTouchStart, {passive: false});
            canvas.addEventListener('touchmove', handleTouchMove, {passive: false});
            canvas.addEventListener('touchend', handleTouchEnd, {passive: false});
        }
        
        function handleTouchStart(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const rect = canvas.getBoundingClientRect();
            const x = (touch.clientX - rect.left) * (canvas.width / rect.width);
            const y = (touch.clientY - rect.top) * (canvas.height / rect.height);
            isDrawing = true;
            ctx.beginPath();
            ctx.moveTo(x, y);
        }
        
        function handleTouchMove(e) {
            if (!isDrawing) return;
            e.preventDefault();
            const touch = e.touches[0];
            const rect = canvas.getBoundingClientRect();
            const x = (touch.clientX - rect.left) * (canvas.width / rect.width);
            const y = (touch.clientY - rect.top) * (canvas.height / rect.height);
            ctx.strokeStyle = currentColor;
            ctx.lineWidth = brushSize;
            ctx.lineTo(x, y);
            ctx.stroke();
        }
        
        function handleTouchEnd(e) {
            e.preventDefault();
            isDrawing = false;
            saveState();
            saveViewData();
        }
        
        function startDrawing(e) {
            isDrawing = true;
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX - rect.left) * (canvas.width / rect.width);
            const y = (e.clientY - rect.top) * (canvas.height / rect.height);
            ctx.beginPath();
            ctx.moveTo(x, y);
        }
        
        function draw(e) {
            if (!isDrawing) return;
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX - rect.left) * (canvas.width / rect.width);
            const y = (e.clientY - rect.top) * (canvas.height / rect.height);
            ctx.strokeStyle = currentColor;
            ctx.lineWidth = brushSize;
            ctx.lineTo(x, y);
            ctx.stroke();
        }
        
        function stopDrawing() {
            if (!isDrawing) return;
            isDrawing = false;
            saveState();
            saveViewData();
        }
        
        function saveState() {
            historyStep++;
            if (historyStep < drawingHistory.length) {
                drawingHistory.length = historyStep;
            }
            drawingHistory.push(canvas.toDataURL());
        }
        
        function undo() {
            if (historyStep > 0) {
                historyStep--;
                const img = new Image();
                img.src = drawingHistory[historyStep];
                img.onload = () => {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0);
                };
            }
        }
        
        function redo() {
            if (historyStep < drawingHistory.length - 1) {
                historyStep++;
                const img = new Image();
                img.src = drawingHistory[historyStep];
                img.onload = () => {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0);
                };
            }
        }

function clearCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (customImage) {
                ctx.drawImage(customImage, 0, 0, canvas.width, canvas.height);
            } else {
                drawBaseHeadIllustration(currentView);
            }
            saveState();
        }
        
        function selectColor(color) {
            currentColor = color;
            document.querySelectorAll('.color-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }
        
        function updateBrushSize(size) {
            brushSize = size;
            document.getElementById('sizeDisplay').textContent = size + 'px';
        }
        
        function changeView(view) {
            saveViewData();
            currentView = view;
            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            loadViewData();
        }
        
        function saveViewData() {
            viewData[currentView] = canvas.toDataURL();
        }
        
        function loadViewData() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (customImage) {
                ctx.drawImage(customImage, 0, 0, canvas.width, canvas.height);
            } else if (!viewData[currentView]) {
                drawBaseHeadIllustration(currentView);
                saveState();
            }
            if (viewData[currentView]) {
                const img = new Image();
                img.src = viewData[currentView];
                img.onload = () => {
                    ctx.drawImage(img, 0, 0);
                };
            }
        }
        
        function uploadCustomImage(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    customImage = new Image();
                    customImage.onload = function() {
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        ctx.drawImage(customImage, 0, 0, canvas.width, canvas.height);
                        document.getElementById('currentImage').src = event.target.result;
                        document.getElementById('currentImage').style.display = 'block';
                        saveState();
                    };
                    customImage.src = event.target.result;
                };
                reader.readAsDataURL(file);
            }
        }
    </script>
</body>
</html>
