<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÁæéÂÆπÂÆ§„Ç´„É´„ÉÜ„Ç∑„Çπ„ÉÜ„É†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f5f5;
            padding: 10px;
            touch-action: none;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
            font-size: 24px;
        }

        .section {
            margin-bottom: 30px;
        }

        .section h2 {
            color: #555;
            font-size: 18px;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #007AFF;
        }

        .customer-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }

        input, textarea, select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        textarea {
            resize: vertical;
            min-height: 60px;
        }

        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
        }

        .menu-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .menu-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }

        .canvas-container {
            position: relative;
            margin-bottom: 15px;
        }

        .view-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .view-btn {
            padding: 8px 16px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .view-btn:hover {
            background: #f0f0f0;
        }

        .view-btn.active {
            background: #007AFF;
            color: white;
            border-color: #007AFF;
        }

        #drawingCanvas {
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            cursor: crosshair;
            display: block;
            width: 100%;
            max-width: 800px;
            height: 400px;
            touch-action: none;
        }

        .drawing-tools {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .tool-btn, .save-btn {
            padding: 8px 16px;
            background: #007AFF;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .tool-btn:hover, .save-btn:hover {
            background: #0056b3;
        }

        .color-picker {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .color-btn {
            width: 30px;
            height: 30px;
            border: 2px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
        }

        .color-btn.active {
            border-color: #007AFF;
            box-shadow: 0 0 0 2px #007AFF;
        }

        input[type="color"] {
            width: 40px;
            height: 30px;
            border: none;
            cursor: pointer;
        }

        .size-control {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        input[type="range"] {
            width: 100px;
        }

        .customer-list {
            margin-top: 20px;
        }

        .customer-item {
            padding: 12px;
            background: #f9f9f9;
            border-radius: 4px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .customer-item:hover {
            background: #e9e9e9;
        }

        .search-box {
            margin-bottom: 15px;
        }

        .search-box input {
            width: 100%;
        }

        .file-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .upload-area {
            border: 2px dashed #ddd;
            border-radius: 4px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            margin-bottom: 10px;
        }

        .upload-area:hover {
            border-color: #007AFF;
            background: #f0f8ff;
        }

        .current-image {
            max-width: 200px;
            margin-top: 10px;
            border-radius: 4px;
        }

        .hair-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        @media (max-width: 768px) {
            .customer-info {
                grid-template-columns: 1fr;
            }
           
            .menu-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }
           
            .drawing-tools {
                flex-direction: column;
                align-items: stretch;
            }
           
            .tool-btn {
                width: 100%;
            }
        }

        .login-container {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .login-container h2 {
            margin-bottom: 20px;
            color: #333;
        }

        .login-container input {
            width: 100%;
            margin-bottom: 15px;
        }

        .login-container button {
            width: 100%;
            padding: 12px;
            background: #007AFF;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }

        .login-container button:hover {
            background: #0056b3;
        }

        .error-message {
            color: #d32f2f;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .success-message {
            color: #2e7d32;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .license-info {
            background: #e3f2fd;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .license-info strong {
            color: #1976d2;
        }

        .license-warning {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 15px;
            color: #856404;
        }

        .license-expired {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            padding: 20px;
            border-radius: 4px;
            text-align: center;
            color: #721c24;
        }

        .device-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            padding: 20px;
            border-radius: 4px;
            text-align: center;
            color: #721c24;
        }

        .logout-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 8px 16px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .logout-btn:hover {
            background: #545b62;
        }

        .info-text {
            font-size: 12px;
            color: #666;
            margin-top: 10px;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div id="loginScreen" class="login-container">
        <h2>üîê ÁæéÂÆπÂÆ§„Ç´„É´„ÉÜ„Ç∑„Çπ„ÉÜ„É†</h2>
        <div id="errorMessage" class="error-message"></div>
        <div id="successMessage" class="success-message"></div>
       
        <div class="form-group">
            <label>„Éë„Çπ„ÉØ„Éº„Éâ</label>
            <input type="password" id="passwordInput" placeholder="„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ">
        </div>
       
        <div class="form-group">
            <label>„É©„Ç§„Çª„É≥„Çπ„Ç≠„Éº</label>
            <input type="text" id="licenseInput" placeholder="‰æã: SALON-A001-20251231-ABC123" style="text-transform: uppercase;">
        </div>
       
        <button onclick="login()">„É≠„Ç∞„Ç§„É≥</button>
       
        <div class="info-text">
            üì± „Åì„ÅÆ„É©„Ç§„Çª„É≥„Çπ„Ç≠„Éº„ÅØ„ÄÅÂàùÂõû„É≠„Ç∞„Ç§„É≥ÊôÇ„Å´„Åì„ÅÆ„Éá„Éê„Ç§„ÇπÔºàiPadÔºâ„Å´Á¥ê‰ªò„Åë„Çâ„Çå„Åæ„Åô„ÄÇ<br>
            Âà•„ÅÆ„Éá„Éê„Ç§„Çπ„Åß„ÅØ‰ΩøÁî®„Åß„Åç„Åæ„Åõ„Çì„ÄÇ
        </div>
       
        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee; font-size: 12px; color: #666; text-align: center;">
            „É©„Ç§„Çª„É≥„Çπ„Ç≠„Éº„ÅÆÊõ¥Êñ∞„Éª„Éá„Éê„Ç§„ÇπÂ§âÊõ¥„Å´„Å§„ÅÑ„Å¶„ÅØË≤©Â£≤ÂÖÉ„Å´„ÅäÂïè„ÅÑÂêà„Çè„Åõ„Åè„Å†„Åï„ÅÑ
        </div>
    </div>

    <div id="expiredScreen" style="display: none;">
        <div class="login-container">
            <div class="license-expired">
                <h2>‚ö†Ô∏è „É©„Ç§„Çª„É≥„ÇπÊúüÈôêÂàá„Çå</h2>
                <p style="margin-top: 15px;">„ÅîÂà©Áî®„ÅÆ„É©„Ç§„Çª„É≥„Çπ„Ç≠„Éº„ÅÆÊúâÂäπÊúüÈôê„ÅåÂàá„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ</p>
                <p style="margin-top: 10px;">Á∂ôÁ∂ö„Åó„Å¶„ÅîÂà©Áî®„ÅÑ„Åü„Å†„Åè„Å´„ÅØ„ÄÅ„É©„Ç§„Çª„É≥„Çπ„ÅÆÊõ¥Êñ∞„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ</p>
                <p style="margin-top: 20px; font-weight: bold;">Ë≤©Â£≤ÂÖÉ„Å´„ÅäÂïè„ÅÑÂêà„Çè„Åõ„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
                <button onclick="location.reload()" style="margin-top: 20px; padding: 10px 30px; background: #007AFF; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    ÂÜç„É≠„Ç∞„Ç§„É≥
                </button>
            </div>
        </div>
    </div>

    <div id="deviceErrorScreen" style="display: none;">
        <div class="login-container">
            <div class="device-error">
                <h2>üö´ „Éá„Éê„Ç§„Çπ„Ç®„É©„Éº</h2>
                <p style="margin-top: 15px;">„Åì„ÅÆ„É©„Ç§„Çª„É≥„Çπ„Ç≠„Éº„ÅØÂà•„ÅÆ„Éá„Éê„Ç§„Çπ„Å´Á¥ê‰ªò„Åë„Çâ„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ</p>
                <p style="margin-top: 10px;">1„Å§„ÅÆ„É©„Ç§„Çª„É≥„Çπ„Ç≠„Éº„ÅØ1Âè∞„ÅÆiPad„Åß„ÅÆ„Åø‰ΩøÁî®„Åß„Åç„Åæ„Åô„ÄÇ</p>
                <p style="margin-top: 20px; font-weight: bold;">„Éá„Éê„Ç§„ÇπÂ§âÊõ¥„Çí„ÅîÂ∏åÊúõ„ÅÆÂ†¥Âêà„ÅØË≤©Â£≤ÂÖÉ„Å´„ÅäÂïè„ÅÑÂêà„Çè„Åõ„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
                <button onclick="location.reload()" style="margin-top: 20px; padding: 10px 30px; background: #007AFF; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Êàª„Çã
                </button>
            </div>
        </div>
    </div>

    <div id="mainApp" style="display: none; position: relative;">
        <button class="logout-btn" onclick="logout()">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
       
        <div class="container">
            <h1>ÁæéÂÆπÂÆ§„Ç´„É´„ÉÜ„Ç∑„Çπ„ÉÜ„É†</h1>
           
            <div id="licenseInfo" class="license-info"></div>
            <div id="licenseWarning" class="license-warning" style="display: none;"></div>
           
            <div class="section">
                <h2>È°ßÂÆ¢ÊÉÖÂ†±</h2>
                <div class="customer-info">
                    <div class="form-group">
                        <label>È°ßÂÆ¢Âêç</label>
                        <input type="text" id="customerName" placeholder="Â±±Áî∞ Â§™ÈÉé">
                    </div>
                    <div class="form-group">
                        <label>ÊãÖÂΩìËÄÖ</label>
                        <input type="text" id="staffName" placeholder="„Çπ„Çø„Ç§„É™„Çπ„ÉàÂêç">
                    </div>
                    <div class="form-group">
                        <label>Êù•Â∫óÊó•</label>
                        <input type="date" id="visitDate">
                    </div>
                    <div class="form-group">
                        <label>ÈõªË©±Áï™Âè∑</label>
                        <input type="tel" id="phoneNumber" placeholder="090-1234-5678">
                    </div>
                </div>
            </div>

            <div class="section">
                <h2>ÊñΩË°ì„É°„Éã„É•„Éº</h2>
                <div class="menu-grid">
                    <div class="menu-item"><input type="checkbox" id="menu_cut"><label for="menu_cut">„Ç´„ÉÉ„Éà</label></div>
                    <div class="menu-item"><input type="checkbox" id="menu_color"><label for="menu_color">„Ç´„É©„Éº</label></div>
                    <div class="menu-item"><input type="checkbox" id="menu_perm"><label for="menu_perm">„Éë„Éº„Éû</label></div>
                    <div class="menu-item"><input type="checkbox" id="menu_treatment"><label for="menu_treatment">„Éà„É™„Éº„Éà„É°„É≥„Éà</label></div>
                    <div class="menu-item"><input type="checkbox" id="menu_head_spa"><label for="menu_head_spa">„Éò„ÉÉ„Éâ„Çπ„Éë</label></div>
                    <div class="menu-item"><input type="checkbox" id="menu_straightening"><label for="menu_straightening">Á∏ÆÊØõÁüØÊ≠£</label></div>
                </div>
            </div>

            <div class="section">
                <h2>„Éò„Ç¢„Çπ„Çø„Ç§„É´Ë®≠Ë®àÂõ≥</h2>
               
                <div class="upload-area" onclick="document.getElementById('imageUpload').click()">
                    <p>üì∑ „Ç´„Çπ„Çø„É†„Ç§„É©„Çπ„Éà„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÔºà„ÇØ„É™„ÉÉ„ÇØÔºâ</p>
                    <input type="file" id="imageUpload" accept="image/*" style="display:none" onchange="uploadCustomImage(event)">
                    <img id="currentImage" class="current-image" style="display:none">
                </div>

                <div class="view-selector">
                    <button class="view-btn active" onclick="changeView('front')">Ê≠£Èù¢</button>
                    <button class="view-btn" onclick="changeView('back')">ËÉåÈù¢</button>
                    <button class="view-btn" onclick="changeView('left')">Â∑¶ÂÅ¥Èù¢</button>
                    <button class="view-btn" onclick="changeView('right')">Âè≥ÂÅ¥Èù¢</button>
                    <button class="view-btn" onclick="changeView('left-front')">Â∑¶Êñú„ÇÅÂâç</button>
                    <button class="view-btn" onclick="changeView('right-front')">Âè≥Êñú„ÇÅÂâç</button>
                    <button class="view-btn" onclick="changeView('left-back')">Â∑¶Êñú„ÇÅÂæå</button>
                    <button class="view-btn" onclick="changeView('right-back')">Âè≥Êñú„ÇÅÂæå</button>
                </div>

                <div class="drawing-tools">
                    <div class="color-picker">
                        <button class="color-btn active" style="background: black" onclick="selectColor('black')"></button>
                        <button class="color-btn" style="background: red" onclick="selectColor('red')"></button>
                        <button class="color-btn" style="background: blue" onclick="selectColor('blue')"></button>
                        <button class="color-btn" style="background: green" onclick="selectColor('green')"></button>
                        <input type="color" id="customColor" value="#000000" onchange="selectColor(this.value)">
                    </div>
                   
                    <div class="size-control">
                        <label>Â§™„Åï:</label>
                        <input type="range" id="brushSize" min="1" max="20" value="2" oninput="updateBrushSize(this.value)">
                        <span id="sizeDisplay">2px</span>
                    </div>
                   
                    <button class="tool-btn" onclick="undo()">‚Ü∂ ÂÖÉ„Å´Êàª„Åô</button>
                    <button class="tool-btn" onclick="redo()">‚Ü∑ „ÇÑ„ÇäÁõ¥„Åó</button>
                    <button class="tool-btn" onclick="clearCanvas()">üóë „ÇØ„É™„Ç¢</button>
                </div>

                <div class="canvas-container">
                    <canvas id="drawingCanvas"></canvas>
                </div>
            </div>

            <div class="section">
                <h2>È´™ÂûãË©≥Á¥∞</h2>
                <div class="hair-details">
                    <div class="form-group">
                        <label>„É¨„É≥„Ç∞„Çπ</label>
                        <select id="length">
                            <option>„Ç∑„Éß„Éº„Éà</option>
                            <option>„Éü„Éá„Ç£„Ç¢„É†</option>
                            <option>„É≠„É≥„Ç∞</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>„Ç´„ÉÉ„Éà„Çπ„Çø„Ç§„É´</label>
                        <input type="text" id="cutStyle" placeholder="‰æã: „É¨„Ç§„É§„Éº">
                    </div>
                    <div class="form-group">
                        <label>„Ç´„É©„Éº</label>
                        <input type="text" id="hairColor" placeholder="‰æã: „Ç¢„ÉÉ„Ç∑„É•„Éñ„É©„Ç¶„É≥">
                    </div>
                    <div class="form-group">
                        <label>„Ç´„É©„Éº„É¨„Éô„É´</label>
                        <input type="text" id="colorLevel" placeholder="‰æã: 8„Éà„Éº„É≥">
                    </div>
                    <div class="form-group">
                        <label>„Éë„Éº„ÉûÁ®ÆÈ°û</label>
                        <input type="text" id="permType" placeholder="‰æã: „Éá„Ç∏„Çø„É´„Éë„Éº„Éû">
                    </div>
                    <div class="form-group">
                        <label>„É≠„ÉÉ„Éâ„Çµ„Ç§„Ç∫</label>
                        <input type="text" id="rodSize" placeholder="‰æã: 14mm">
                    </div>
                    <div class="form-group">
                        <label>ÂâçÈ´™</label>
                        <input type="text" id="bangs" placeholder="‰æã: „Ç∑„Éº„Çπ„É´„Éº„Éê„É≥„Ç∞">
                    </div>
                    <div class="form-group">
                        <label>È°îÂë®„Çä</label>
                        <input type="text" id="faceFrame" placeholder="‰æã: „É¨„Ç§„É§„ÉºÂº∑„ÇÅ">
                    </div>
                    <div class="form-group">
                        <label>ÊØõÈáèË™øÊï¥</label>
                        <input type="text" id="volume" placeholder="‰æã: ËªΩ„ÇÅ">
                    </div>
                    <div class="form-group">
                        <label>„Åù„ÅÆ‰ªñÊäÄË°ì</label>
                        <input type="text" id="otherTech" placeholder="‰æã: „Éè„Ç§„É©„Ç§„Éà">
                    </div>
                </div>
                <div class="form-group" style="margin-top: 15px;">
                    <label>ÂÇôËÄÉÊ¨Ñ</label>
                    <textarea id="notes" rows="4" placeholder="ÊñΩË°ìÂÜÖÂÆπ„ÅÆË©≥Á¥∞„ÄÅ„ÅäÂÆ¢Êßò„ÅÆË¶ÅÊúõ„ÄÅÊ≥®ÊÑè‰∫ãÈ†Ö„Å™„Å©"></textarea>
                </div>
            </div>

            <div class="section">
                <button class="save-btn" onclick="saveChart()">üíæ „Ç´„É´„ÉÜ„Çí‰øùÂ≠ò</button>
                <button class="save-btn" onclick="newChart()">üìù Êñ∞Ë¶è„Ç´„É´„ÉÜ</button>
               
                <div class="file-controls">
                    <button class="save-btn" onclick="exportToJSON()">üì• JSON„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ</button>
                    <label class="save-btn" style="display: inline-block; text-align: center;">
                        üì§ JSONË™≠Ëæº
                        <input type="file" accept=".json" onchange="importFromJSON(event)" style="display:none">
                    </label>
                </div>
            </div>

            <div class="section">
                <h2>È°ßÂÆ¢‰∏ÄË¶ß</h2>
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="üîç È°ßÂÆ¢Âêç„ÄÅÊãÖÂΩìËÄÖ„ÄÅÈõªË©±Áï™Âè∑„ÅßÊ§úÁ¥¢..." oninput="searchCustomers()">
                </div>
                <div id="customerList" class="customer-list"></div>
            </div>
        </div>
    </div>

    <script>
        const PASSWORD = 'salon2024';
        let canvas, ctx;
        let isDrawing = false;
        let currentColor = 'black';
        let brushSize = 2;
        let currentView = 'front';
        let drawingHistory = [];
        let historyStep = -1;
        let customImage = null;
        let currentLicense = null;

        const viewData = {
            'front': [], 'back': [], 'left': [], 'right': [],
            'left-front': [], 'right-front': [], 'left-back': [], 'right-back': []
        };

        // „Éá„Éê„Ç§„ÇπID„ÇíÁîüÊàêÔºàiPadÂõ∫Êúâ„ÅÆË≠òÂà•Â≠êÔºâ
        function getDeviceId() {
            const ua = navigator.userAgent;
            const screen_data = screen.width + 'x' + screen.height + 'x' + screen.colorDepth;
            const canvas_fp = getCanvasFingerprint();
            const webgl_fp = getWebGLFingerprint();
           
            const combined = ua + screen_data + canvas_fp + webgl_fp;
            return hashString(combined);
        }

        // CanvasÊåáÁ¥ã
        function getCanvasFingerprint() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            ctx.textBaseline = 'top';
            ctx.font = '14px Arial';
            ctx.fillText('fingerprint', 2, 2);
            return canvas.toDataURL();
        }

        // WebGLÊåáÁ¥ã
        function getWebGLFingerprint() {
            const canvas = document.createElement('canvas');
            const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
            if (!gl) return 'no-webgl';
           
            const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
            if (!debugInfo) return 'no-debug-info';
           
            return gl.getParameter(debugInfo.UNMASKED_VENDOR_WEBGL) + '~' +
                   gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL);
        }

        // ÊñáÂ≠óÂàó„Çí„Éè„ÉÉ„Ç∑„É•Âåñ
        function hashString(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return Math.abs(hash).toString(36);
        }

        // „É©„Ç§„Çª„É≥„Çπ„Ç≠„ÉºÊ§úË®º
        function validateLicense(licenseKey, deviceId = null) {
            if (!licenseKey) return { valid: false, error: '„É©„Ç§„Çª„É≥„Çπ„Ç≠„Éº„ÅåÂÖ•Âäõ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì' };
           
            const parts = licenseKey.toUpperCase().split('-');
           
            if (parts.length !== 4 || parts[0] !== 'SALON') {
                return { valid: false, error: '„É©„Ç§„Çª„É≥„Çπ„Ç≠„Éº„ÅÆÂΩ¢Âºè„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì' };
            }
           
            const shopId = parts[1];
            const expireDateStr = parts[2];
            const checksum = parts[3];
           
            if (expireDateStr.length !== 8) {
                return { valid: false, error: '„É©„Ç§„Çª„É≥„Çπ„Ç≠„Éº„ÅÆÂΩ¢Âºè„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì' };
            }
           
            const year = expireDateStr.substring(0, 4);
            const month = expireDateStr.substring(4, 6);
            const day = expireDateStr.substring(6, 8);
            const expireDate = new Date(year, month - 1, day);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
           
            if (expireDate < today) {
                return {
                    valid: false,
                    expired: true,
                    error: '„É©„Ç§„Çª„É≥„Çπ„Ç≠„Éº„ÅÆÊúâÂäπÊúüÈôê„ÅåÂàá„Çå„Å¶„ÅÑ„Åæ„Åô',
                    expireDate: expireDate
                };
            }
           
            const expectedChecksum = simpleHash(shopId + expireDateStr);
            if (checksum !== expectedChecksum) {
                return { valid: false, error: '„É©„Ç§„Çª„É≥„Çπ„Ç≠„Éº„ÅåÁÑ°Âäπ„Åß„Åô' };
            }
           
            // „Éá„Éê„Ç§„ÇπÁ¥ê‰ªò„Åë„ÉÅ„Çß„ÉÉ„ÇØ
            if (deviceId) {
                const savedDeviceId = localStorage.getItem('device_' + licenseKey);
                if (savedDeviceId && savedDeviceId !== deviceId) {
                    return {
                        valid: false,
                        deviceMismatch: true,
                        error: '„Åì„ÅÆ„É©„Ç§„Çª„É≥„Çπ„Ç≠„Éº„ÅØÂà•„ÅÆ„Éá„Éê„Ç§„Çπ„Å´Á¥ê‰ªò„Åë„Çâ„Çå„Å¶„ÅÑ„Åæ„Åô'
                    };
                }
            }
           
            const daysUntilExpire = Math.ceil((expireDate - today) / (1000 * 60 * 60 * 24));
            const warning = daysUntilExpire <= 30 ? `„É©„Ç§„Çª„É≥„ÇπÊúâÂäπÊúüÈôê„Åæ„ÅßÊÆã„Çä${daysUntilExpire}Êó•„Åß„Åô` : null;
           
            return {
                valid: true,
                shopId: shopId,
                expireDate: expireDate,
                daysUntilExpire: daysUntilExpire,
                warning: warning
            };
        }

        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = ((hash << 5) - hash) + str.charCodeAt(i);
                hash = hash & hash;
            }
            return Math.abs(hash).toString(36).toUpperCase().substring(0, 6);
        }

        function generateLicense(shopId, expireDate) {
            const dateStr = expireDate.toISOString().split('T')[0].replace(/-/g, '');
            const checksum = simpleHash(shopId + dateStr);
            return `SALON-${shopId}-${dateStr}-${checksum}`;
        }

        function login() {
            const password = document.getElementById('passwordInput').value;
            const licenseKey = document.getElementById('licenseInput').value.trim();
            const deviceId = getDeviceId();
           
            document.getElementById('errorMessage').textContent = '';
            document.getElementById('successMessage').textContent = '';
           
            if (password !== PASSWORD) {
                document.getElementById('errorMessage').textContent = '„Éë„Çπ„ÉØ„Éº„Éâ„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì';
                return;
            }
           
            const validation = validateLicense(licenseKey, deviceId);
           
            if (!validation.valid) {
                if (validation.expired) {
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('expiredScreen').style.display = 'block';
                } else if (validation.deviceMismatch) {
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('deviceErrorScreen').style.display = 'block';
                } else {
                    document.getElementById('errorMessage').textContent = validation.error;
                }
                return;
            }
           
            // ÂàùÂõû„É≠„Ç∞„Ç§„É≥ÊôÇ„Å´„Éá„Éê„Ç§„ÇπID„Çí‰øùÂ≠ò
            if (!localStorage.getItem('device_' + licenseKey)) {
                localStorage.setItem('device_' + licenseKey, deviceId);
            }
           
            currentLicense = {
                key: licenseKey,
                shopId: validation.shopId,
                expireDate: validation.expireDate,
                daysUntilExpire: validation.daysUntilExpire,
                deviceId: deviceId
            };
            localStorage.setItem('currentLicense', JSON.stringify(currentLicense));
           
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
           
            showLicenseInfo();
            initCanvas();
            loadCustomerList();
            document.getElementById('visitDate').valueAsDate = new Date();
        }

        function showLicenseInfo() {
            if (!currentLicense) return;
           
            const expireDateStr = currentLicense.expireDate.toLocaleDateString('ja-JP');
            const infoDiv = document.getElementById('licenseInfo');
            infoDiv.innerHTML = `<strong>Â∫óËàóID:</strong> ${currentLicense.shopId} | <strong>„É©„Ç§„Çª„É≥„ÇπÊúâÂäπÊúüÈôê:</strong> ${expireDateStr} | <strong>üì± „Åì„ÅÆ„Éá„Éê„Ç§„Çπ„Å´Á¥ê‰ªò„ÅëÊ∏à</strong>`;
           
            if (currentLicense.daysUntilExpire <= 30) {
                const warningDiv = document.getElementById('licenseWarning');
                warningDiv.style.display = 'block';
                warningDiv.innerHTML = `‚ö†Ô∏è „É©„Ç§„Çª„É≥„ÇπÊúâÂäπÊúüÈôê„Åæ„ÅßÊÆã„Çä<strong>${currentLicense.daysUntilExpire}Êó•</strong>„Åß„Åô„ÄÇÊõ¥Êñ∞„Çí„ÅîÊ§úË®é„Åè„Å†„Åï„ÅÑ„ÄÇ`;
            }
        }

        function logout() {
            if (confirm('„É≠„Ç∞„Ç¢„Ç¶„Éà„Åó„Åæ„Åô„ÅãÔºü')) {
                localStorage.removeItem('currentLicense');
                location.reload();
            }
        }

        window.addEventListener('load', function() {
            const savedLicense = localStorage.getItem('currentLicense');
            if (savedLicense) {
                currentLicense = JSON.parse(savedLicense);
                currentLicense.expireDate = new Date(currentLicense.expireDate);
               
                const currentDeviceId = getDeviceId();
                const validation = validateLicense(currentLicense.key, currentDeviceId);
               
                if (validation.valid) {
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('mainApp').style.display = 'block';
                    showLicenseInfo();
                    initCanvas();
                    loadCustomerList();
                } else {
                    localStorage.removeItem('currentLicense');
                    if (validation.expired) {
                        document.getElementById('loginScreen').style.display = 'none';
                        document.getElementById('expiredScreen').style.display = 'block';
                    } else if (validation.deviceMismatch) {
                        document.getElementById('loginScreen').style.display = 'none';
                        document.getElementById('deviceErrorScreen').style.display = 'block';
                    }
                }
            }
        });

        function initCanvas() {
            canvas = document.getElementById('drawingCanvas');
            ctx = canvas.getContext('2d');
           
            canvas.width = 800;
            canvas.height = 400;
           
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
           
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
           
            canvas.addEventListener('touchstart', handleTouchStart, {passive: false});
            canvas.addEventListener('touchmove', handleTouchMove, {passive: false});
            canvas.addEventListener('touchend', handleTouchEnd, {passive: false});
           
            loadViewData();
        }

        function handleTouchStart(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const rect = canvas.getBoundingClientRect();
            const x = touch.clientX - rect.left;
            const y = touch.clientY - rect.top;
           
            isDrawing = true;
            ctx.beginPath();
            ctx.moveTo(x, y);
            saveState();
        }

        function handleTouchMove(e) {
            if (!isDrawing) return;
            e.preventDefault();
           
            const touch = e.touches[0];
            const rect = canvas.getBoundingClientRect();
            const x = touch.clientX - rect.left;
            const y = touch.clientY - rect.top;
           
            ctx.strokeStyle = currentColor;
            ctx.lineWidth = brushSize;
            ctx.lineTo(x, y);
            ctx.stroke();
        }

        function handleTouchEnd(e) {
            e.preventDefault();
            isDrawing = false;
            saveViewData();
        }

        function startDrawing(e) {
            isDrawing = true;
            const rect = canvas.getBoundingClientRect();
            ctx.beginPath();
            ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
            saveState();
        }

        function draw(e) {
            if (!isDrawing) return;
           
            const rect = canvas.getBoundingClientRect();
            ctx.strokeStyle = currentColor;
            ctx.lineWidth = brushSize;
            ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
            ctx.stroke();
        }

        function stopDrawing() {
            isDrawing = false;
            saveViewData();
        }

        function saveState() {
            historyStep++;
            if (historyStep < drawingHistory.length) {
                drawingHistory.length = historyStep;
            }
            drawingHistory.push(canvas.toDataURL());
        }

        function undo() {
            if (historyStep > 0) {
                historyStep--;
                const img = new Image();
                img.src = drawingHistory[historyStep];
                img.onload = () => {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0);
                };
            }
        }

        function redo() {
            if (historyStep < drawingHistory.length - 1) {
                historyStep++;
                const img = new Image();
                img.src = drawingHistory[historyStep];
                img.onload = () => {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0);
                };
            }
        }

        function clearCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (customImage) {
                ctx.drawImage(customImage, 0, 0, canvas.width, canvas.height);
            }
            saveState();
            saveViewData();
        }

        function selectColor(color) {
            currentColor = color;
            document.querySelectorAll('.color-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        function updateBrushSize(size) {
            brushSize = size;
            document.getElementById('sizeDisplay').textContent = size + 'px';
        }

        function changeView(view) {
            saveViewData();
            currentView = view;
           
            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
           
            loadViewData();
        }

        function saveViewData() {
            viewData[currentView] = canvas.toDataURL();
        }

        function loadViewData() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
           
            if (customImage) {
                ctx.drawImage(customImage, 0, 0, canvas.width, canvas.height);
            }
           
            if (viewData[currentView]) {
                const img = new Image();
                img.src = viewData[currentView];
                img.onload = () => ctx.drawImage(img, 0, 0);
            }
        }

        function uploadCustomImage(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    customImage = new Image();
                    customImage.onload = function() {
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        ctx.drawImage(customImage, 0, 0, canvas.width, canvas.height);
                        document.getElementById('currentImage').src = event.target.result;
                        document.getElementById('currentImage').style.display = 'block';
                        saveState();
                    };
                    customImage.src = event.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        function saveChart() {
            saveViewData();
           
            const chartData = {
                id: Date.now(),
                customerName: document.getElementById('customerName').value,
                staffName: document.getElementById('staffName').value,
                visitDate: document.getElementById('visitDate').value,
                phoneNumber: document.getElementById('phoneNumber').value,
                menus: Array.from(document.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.id),
                drawings: viewData,
                customImage: customImage ? customImage.src : null,
                hairDetails: {
                    length: document.getElementById('length').value,
                    cutStyle: document.getElementById('cutStyle').value,
                    hairColor: document.getElementById('hairColor').value,
                    colorLevel: document.getElementById('colorLevel').value,
                    permType: document.getElementById('permType').value,
                    rodSize: document.getElementById('rodSize').value,
                    bangs: document.getElementById('bangs').value,
                    faceFrame: document.getElementById('faceFrame').value,
                    volume: document.getElementById('volume').value,
                    otherTech: document.getElementById('otherTech').value,
                    notes: document.getElementById('notes').value
                }
            };
           
            let charts = JSON.parse(localStorage.getItem('salonCharts') || '[]');
            const existingIndex = charts.findIndex(c => c.id === chartData.id);
           
            if (existingIndex >= 0) {
                charts[existingIndex] = chartData;
            } else {
                charts.push(chartData);
            }
           
            localStorage.setItem('salonCharts', JSON.stringify(charts));
            alert('„Ç´„É´„ÉÜ„Çí‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅ');
            loadCustomerList();
        }

        function newChart() {
            if (confirm('Êñ∞Ë¶è„Ç´„É´„ÉÜ„Çí‰ΩúÊàê„Åó„Åæ„Åô„ÅãÔºüÊú™‰øùÂ≠ò„ÅÆ„Éá„Éº„Çø„ÅØÂ§±„Çè„Çå„Åæ„Åô„ÄÇ')) {
                document.getElementById('customerName').value = '';
                document.getElementById('staffName').value = '';
                document.getElementById('phoneNumber').value = '';
                document.getElementById('visitDate').valueAsDate = new Date();
                document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
               
                Object.keys(viewData).forEach(view => viewData[view] = []);
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                customImage = null;
                document.getElementById('currentImage').style.display = 'none';
               
                document.querySelectorAll('.hair-details input, .hair-details select, #notes').forEach(el => el.value = '');
               
                currentView = 'front';
                document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelector('.view-btn').classList.add('active');
            }
        }

        function loadCustomerList() {
            const charts = JSON.parse(localStorage.getItem('salonCharts') || '[]');
            const listDiv = document.getElementById('customerList');
           
            listDiv.innerHTML = charts.sort((a, b) => b.id - a.id).map(chart => `
                <div class="customer-item" onclick="loadChart(${chart.id})">
                    <strong>${chart.customerName}</strong> ${chart.staffName ? `(ÊãÖÂΩì: ${chart.staffName})` : ''} | ${chart.visitDate} | ${chart.phoneNumber}
                </div>
            `).join('');
        }

        function searchCustomers() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            const charts = JSON.parse(localStorage.getItem('salonCharts') || '[]');
           
            const filtered = charts.filter(chart =>
                chart.customerName.toLowerCase().includes(query) ||
                chart.phoneNumber.includes(query) ||
                (chart.staffName && chart.staffName.toLowerCase().includes(query))
            );
           
            const listDiv = document.getElementById('customerList');
            listDiv.innerHTML = filtered.map(chart => `
                <div class="customer-item" onclick="loadChart(${chart.id})">
                    <strong>${chart.customerName}</strong> ${chart.staffName ? `(ÊãÖÂΩì: ${chart.staffName})` : ''} | ${chart.visitDate} | ${chart.phoneNumber}
                </div>
            `).join('');
        }

        function loadChart(id) {
            const charts = JSON.parse(localStorage.getItem('salonCharts') || '[]');
            const chart = charts.find(c => c.id === id);
           
            if (chart) {
                document.getElementById('customerName').value = chart.customerName;
                document.getElementById('staffName').value = chart.staffName || '';
                document.getElementById('visitDate').value = chart.visitDate;
                document.getElementById('phoneNumber').value = chart.phoneNumber;
               
                document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                    cb.checked = chart.menus.includes(cb.id);
                });
               
                Object.assign(viewData, chart.drawings);
               
                if (chart.customImage) {
                    customImage = new Image();
                    customImage.src = chart.customImage;
                    document.getElementById('currentImage').src = chart.customImage;
                    document.getElementById('currentImage').style.display = 'block';
                }
               
                if (chart.hairDetails) {
                    document.getElementById('length').value = chart.hairDetails.length || '';
                    document.getElementById('cutStyle').value = chart.hairDetails.cutStyle || '';
                    document.getElementById('hairColor').value = chart.hairDetails.hairColor || '';
                    document.getElementById('colorLevel').value = chart.hairDetails.colorLevel || '';
                    document.getElementById('permType').value = chart.hairDetails.permType || '';
                    document.getElementById('rodSize').value = chart.hairDetails.rodSize || '';
                    document.getElementById('bangs').value = chart.hairDetails.bangs || '';
                    document.getElementById('faceFrame').value = chart.hairDetails.faceFrame || '';
                    document.getElementById('volume').value = chart.hairDetails.volume || '';
                    document.getElementById('otherTech').value = chart.hairDetails.otherTech || '';
                    document.getElementById('notes').value = chart.hairDetails.notes || '';
                }
               
                loadViewData();
            }
        }

        function exportToJSON() {
            const charts = JSON.parse(localStorage.getItem('salonCharts') || '[]');
            const dataStr = JSON.stringify(charts, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `salon_charts_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importFromJSON(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const charts = JSON.parse(event.target.result);
                        localStorage.setItem('salonCharts', JSON.stringify(charts));
                        alert('„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„ÅüÔºÅ');
                        loadCustomerList();
                    } catch (error) {
                        alert('„Éï„Ç°„Ç§„É´„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                    }
                };
                reader.readAsText(file);
            }
        }

        document.getElementById('passwordInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('licenseInput').focus();
            }
        });

        document.getElementById('licenseInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                login();
            }
        });
    </script>
</body>
</html> 
