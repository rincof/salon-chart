<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¾å®¹å®¤ã‚«ãƒ«ãƒ†ã‚·ã‚¹ãƒ†ãƒ </title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f5f5;
            padding: 10px;
            touch-action: none;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
            font-size: 24px;
        }

        .section {
            margin-bottom: 30px;
        }

        .section h2 {
            color: #555;
            font-size: 18px;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #007AFF;
        }

        .customer-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }

        input, textarea, select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        textarea {
            resize: vertical;
            min-height: 60px;
        }

        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
        }

        .menu-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .menu-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }

        .canvas-container {
            position: relative;
            margin-bottom: 15px;
        }

        .view-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .view-btn {
            padding: 8px 16px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .view-btn:hover {
            background: #f0f0f0;
        }

        .view-btn.active {
            background: #007AFF;
            color: white;
            border-color: #007AFF;
        }

        #drawingCanvas {
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            cursor: crosshair;
            display: block;
            width: 100%;
            max-width: 800px;
            height: 400px;
            touch-action: none;
        }

        .drawing-tools {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .tool-btn, .save-btn {
            padding: 8px 16px;
            background: #007AFF;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .tool-btn:hover, .save-btn:hover {
            background: #0056b3;
        }

        .color-picker {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .color-btn {
            width: 30px;
            height: 30px;
            border: 2px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
        }

        .color-btn.active {
            border-color: #007AFF;
            box-shadow: 0 0 0 2px #007AFF;
        }

        input[type="color"] {
            width: 40px;
            height: 30px;
            border: none;
            cursor: pointer;
        }

        .size-control {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        input[type="range"] {
            width: 100px;
        }

        .customer-list {
            margin-top: 20px;
        }

        .customer-item {
            padding: 12px;
            background: #f9f9f9;
            border-radius: 4px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .customer-item:hover {
            background: #e9e9e9;
        }

        .search-box {
            margin-bottom: 15px;
        }

        .search-box input {
            width: 100%;
        }

        .file-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .upload-area {
            border: 2px dashed #ddd;
            border-radius: 4px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            margin-bottom: 10px;
        }

        .upload-area:hover {
            border-color: #007AFF;
            background: #f0f8ff;
        }

        .current-image {
            max-width: 200px;
            margin-top: 10px;
            border-radius: 4px;
        }

        .hair-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        @media (max-width: 768px) {
            .customer-info {
                grid-template-columns: 1fr;
            }
           
            .menu-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }
           
            .drawing-tools {
                flex-direction: column;
                align-items: stretch;
            }
           
            .tool-btn {
                width: 100%;
            }
        }

        .login-container {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .login-container h2 {
            margin-bottom: 20px;
            color: #333;
        }

        .login-container input {
            width: 100%;
            margin-bottom: 15px;
        }

        .login-container button {
            width: 100%;
            padding: 12px;
            background: #007AFF;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }

        .login-container button:hover {
            background: #0056b3;
        }

        .error-message {
            color: #d32f2f;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .success-message {
            color: #2e7d32;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .license-info {
            background: #e3f2fd;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .license-info strong {
            color: #1976d2;
        }

        .license-warning {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 12px;
            border-radius: 4px;
            margin-bottom: 15px;
            color: #856404;
        }

        .license-expired {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            padding: 20px;
            border-radius: 4px;
            text-align: center;
            color: #721c24;
        }

        .device-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            padding: 20px;
            border-radius: 4px;
            text-align: center;
            color: #721c24;
        }

        .logout-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 8px 16px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .logout-btn:hover {
            background: #545b62;
        }

        .info-text {
            font-size: 12px;
            color: #666;
            margin-top: 10px;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div id="loginScreen" class="login-container">
        <h2>ğŸ” ç¾å®¹å®¤ã‚«ãƒ«ãƒ†ã‚·ã‚¹ãƒ†ãƒ </h2>
        <div id="errorMessage" class="error-message"></div>
        <div id="successMessage" class="success-message"></div>
       
        <div class="form-group">
            <label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
            <input type="password" id="passwordInput" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
        </div>
       
        <div class="form-group">
            <label>ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã‚­ãƒ¼</label>
            <input type="text" id="licenseInput" placeholder="ä¾‹: SALON-A001-20251231-ABC123" style="text-transform: uppercase;">
        </div>
       
        <button onclick="login()">ãƒ­ã‚°ã‚¤ãƒ³</button>
       
        <div class="info-text">
            ğŸ“± ã“ã®ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã‚­ãƒ¼ã¯ã€åˆå›ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã«ã“ã®ãƒ‡ãƒã‚¤ã‚¹ï¼ˆiPadï¼‰ã«ç´ä»˜ã‘ã‚‰ã‚Œã¾ã™ã€‚<br>
            åˆ¥ã®ãƒ‡ãƒã‚¤ã‚¹ã§ã¯ä½¿ç”¨ã§ãã¾ã›ã‚“ã€‚
        </div>
       
        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee; font-size: 12px; color: #666; text-align: center;">
            ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã‚­ãƒ¼ã®æ›´æ–°ãƒ»ãƒ‡ãƒã‚¤ã‚¹å¤‰æ›´ã«ã¤ã„ã¦ã¯è²©å£²å…ƒã«ãŠå•ã„åˆã‚ã›ãã ã•ã„
        </div>
    </div>

    <div id="expiredScreen" style="display: none;">
        <div class="login-container">
            <div class="license-expired">
                <h2>âš ï¸ ãƒ©ã‚¤ã‚»ãƒ³ã‚¹æœŸé™åˆ‡ã‚Œ</h2>
                <p style="margin-top: 15px;">ã”åˆ©ç”¨ã®ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã‚­ãƒ¼ã®æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¦ã„ã¾ã™ã€‚</p>
                <p style="margin-top: 10px;">ç¶™ç¶šã—ã¦ã”åˆ©ç”¨ã„ãŸã ãã«ã¯ã€ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã®æ›´æ–°ãŒå¿…è¦ã§ã™ã€‚</p>
                <p style="margin-top: 20px; font-weight: bold;">è²©å£²å…ƒã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚</p>
                <button onclick="location.reload()" style="margin-top: 20px; padding: 10px 30px; background: #007AFF; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    å†ãƒ­ã‚°ã‚¤ãƒ³
                </button>
            </div>
        </div>
    </div>

    <div id="deviceErrorScreen" style="display: none;">
        <div class="login-container">
            <div class="device-error">
                <h2>ğŸš« ãƒ‡ãƒã‚¤ã‚¹ã‚¨ãƒ©ãƒ¼</h2>
                <p style="margin-top: 15px;">ã“ã®ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã‚­ãƒ¼ã¯åˆ¥ã®ãƒ‡ãƒã‚¤ã‚¹ã«ç´ä»˜ã‘ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚</p>
                <p style="margin-top: 10px;">1ã¤ã®ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã‚­ãƒ¼ã¯1å°ã®iPadã§ã®ã¿ä½¿ç”¨ã§ãã¾ã™ã€‚</p>
                <p style="margin-top: 20px; font-weight: bold;">ãƒ‡ãƒã‚¤ã‚¹å¤‰æ›´ã‚’ã”å¸Œæœ›ã®å ´åˆã¯è²©å£²å…ƒã«ãŠå•ã„åˆã‚ã›ãã ã•ã„ã€‚</p>
                <button onclick="location.reload()" style="margin-top: 20px; padding: 10px 30px; background: #007AFF; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    æˆ»ã‚‹
                </button>
            </div>
        </div>
    </div>

    <div id="mainApp" style="display: none; position: relative;">
        <button class="logout-btn" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
       
        <div class="container">
            <h1>ç¾å®¹å®¤ã‚«ãƒ«ãƒ†ã‚·ã‚¹ãƒ†ãƒ </h1>
           
            <div id="licenseInfo" class="license-info"></div>
            <div id="licenseWarning" class="license-warning" style="display: none;"></div>
           
            <div class="section">
                <h2>é¡§å®¢æƒ…å ±</h2>
                <div class="customer-info">
                    <div class="form-group">
                        <label>é¡§å®¢å</label>
                        <input type="text" id="customerName" placeholder="å±±ç”° å¤ªéƒ">
                    </div>
                    <div class="form-group">
                        <label>æ‹…å½“è€…</label>
                        <input type="text" id="staffName" placeholder="ã‚¹ã‚¿ã‚¤ãƒªã‚¹ãƒˆå">
                    </div>
                    <div class="form-group">
                        <label>æ¥åº—æ—¥</label>
                        <input type="date" id="visitDate">
                    </div>
                    <div class="form-group">
                        <label>é›»è©±ç•ªå·</label>
                        <input type="tel" id="phoneNumber" placeholder="090-1234-5678">
                    </div>
                </div>
            </div>

            <div class="section">
                <h2>æ–½è¡“ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h2>
                <div class="menu-grid">
                    <div class="menu-item"><input type="checkbox" id="menu_cut"><label for="menu_cut">ã‚«ãƒƒãƒˆ</label></div>
                    <div class="menu-item"><input type="checkbox" id="menu_color"><label for="menu_color">ã‚«ãƒ©ãƒ¼</label></div>
                    <div class="menu-item"><input type="checkbox" id="menu_perm"><label for="menu_perm">ãƒ‘ãƒ¼ãƒ</label></div>
                    <div class="menu-item"><input type="checkbox" id="menu_treatment"><label for="menu_treatment">ãƒˆãƒªãƒ¼ãƒˆãƒ¡ãƒ³ãƒˆ</label></div>
                    <div class="menu-item"><input type="checkbox" id="menu_head_spa"><label for="menu_head_spa">ãƒ˜ãƒƒãƒ‰ã‚¹ãƒ‘</label></div>
                    <div class="menu-item"><input type="checkbox" id="menu_straightening"><label for="menu_straightening">ç¸®æ¯›çŸ¯æ­£</label></div>
                </div>
            </div>

            <div class="section">
                <h2>ãƒ˜ã‚¢ã‚¹ã‚¿ã‚¤ãƒ«è¨­è¨ˆå›³</h2>
               
                <div class="upload-area" onclick="document.getElementById('imageUpload').click()">
                    <p>ğŸ“· ã‚«ã‚¹ã‚¿ãƒ ã‚¤ãƒ©ã‚¹ãƒˆã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆã‚¯ãƒªãƒƒã‚¯ï¼‰</p>
                    <input type="file" id="imageUpload" accept="image/*" style="display:none" onchange="uploadCustomImage(event)">
                    <img id="currentImage" class="current-image" style="display:none">
                </div>

                <div class="view-selector">
                    <button class="view-btn active" onclick="changeView('front')">æ­£é¢</button>
                    <button class="view-btn" onclick="changeView('back')">èƒŒé¢</button>
                    <button class="view-btn" onclick="changeView('left')">å·¦å´é¢</button>
                    <button class="view-btn" onclick="changeView('right')">å³å´é¢</button>
                    <button class="view-btn" onclick="changeView('left-front')">å·¦æ–œã‚å‰</button>
                    <button class="view-btn" onclick="changeView('right-front')">å³æ–œã‚å‰</button>
                    <button class="view-btn" onclick="changeView('left-back')">å·¦æ–œã‚å¾Œ</button>
                    <button class="view-btn" onclick="changeView('right-back')">å³æ–œã‚å¾Œ</button>
                </div>

                <div class="drawing-tools">
                    <div class="color-picker">
                        <button class="color-btn active" style="background: black" onclick="selectColor('black')"></button>
                        <button class="color-btn" style="background: red" onclick="selectColor('red')"></button>
                        <button class="color-btn" style="background: blue" onclick="selectColor('blue')"></button>
                        <button class="color-btn" style="background: green" onclick="selectColor('green')"></button>
                        <input type="color" id="customColor" value="#000000" onchange="selectColor(this.value)">
                    </div>
                   
                    <div class="size-control">
                        <label>å¤ªã•:</label>
                        <input type="range" id="brushSize" min="1" max="20" value="2" oninput="updateBrushSize(this.value)">
                        <span id="sizeDisplay">2px</span>
                    </div>
                   
                    <button class="tool-btn" onclick="undo()">â†¶ å…ƒã«æˆ»ã™</button>
                    <button class="tool-btn" onclick="redo()">â†· ã‚„ã‚Šç›´ã—</button>
                    <button class="tool-btn" onclick="clearCanvas()">ğŸ—‘ ã‚¯ãƒªã‚¢</button>
                </div>

                <div class="canvas-container">
                    <canvas id="drawingCanvas"></canvas>
                </div>
            </div>

            <div class="section">
                <h2>é«ªå‹è©³ç´°</h2>
                <div class="hair-details">
                    <div class="form-group">
                        <label>ãƒ¬ãƒ³ã‚°ã‚¹</label>
                        <select id="length">
                            <option>ã‚·ãƒ§ãƒ¼ãƒˆ</option>
                            <option>ãƒŸãƒ‡ã‚£ã‚¢ãƒ </option>
                            <option>ãƒ­ãƒ³ã‚°</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ã‚«ãƒƒãƒˆã‚¹ã‚¿ã‚¤ãƒ«</label>
                        <input type="text" id="cutStyle" placeholder="ä¾‹: ãƒ¬ã‚¤ãƒ¤ãƒ¼">
                    </div>
                    <div class="form-group">
                        <label>ã‚«ãƒ©ãƒ¼</label>
                        <input type="text" id="hairColor" placeholder="ä¾‹: ã‚¢ãƒƒã‚·ãƒ¥ãƒ–ãƒ©ã‚¦ãƒ³">
                    </div>
                    <div class="form-group">
                        <label>ã‚«ãƒ©ãƒ¼ãƒ¬ãƒ™ãƒ«</label>
                        <input type="text" id="colorLevel" placeholder="ä¾‹: 8ãƒˆãƒ¼ãƒ³">
                    </div>
                    <div class="form-group">
                        <label>ãƒ‘ãƒ¼ãƒç¨®é¡</label>
                        <input type="text" id="permType" placeholder="ä¾‹: ãƒ‡ã‚¸ã‚¿ãƒ«ãƒ‘ãƒ¼ãƒ">
                    </div>
                    <div class="form-group">
                        <label>ãƒ­ãƒƒãƒ‰ã‚µã‚¤ã‚º</label>
                        <input type="text" id="rodSize" placeholder="ä¾‹: 14mm">
                    </div>
                    <div class="form-group">
                        <label>å‰é«ª</label>
                        <input type="text" id="bangs" placeholder="ä¾‹: ã‚·ãƒ¼ã‚¹ãƒ«ãƒ¼ãƒãƒ³ã‚°">
                    </div>
                    <div class="form-group">
                        <label>é¡”å‘¨ã‚Š</label>
                        <input type="text" id="faceFrame" placeholder="ä¾‹: ãƒ¬ã‚¤ãƒ¤ãƒ¼å¼·ã‚">
                    </div>
                    <div class="form-group">
                        <label>æ¯›é‡èª¿æ•´</label>
                        <input type="text" id="volume" placeholder="ä¾‹: è»½ã‚">
                    </div>
                    <div class="form-group">
                        <label>ãã®ä»–æŠ€è¡“</label>
                        <input type="text" id="otherTech" placeholder="ä¾‹: ãƒã‚¤ãƒ©ã‚¤ãƒˆ">
                    </div>
                </div>
                <div class="form-group" style="margin-top: 15px;">
                    <label>å‚™è€ƒæ¬„</label>
                    <textarea id="notes" rows="4" placeholder="æ–½è¡“å†…å®¹ã®è©³ç´°ã€ãŠå®¢æ§˜ã®è¦æœ›ã€æ³¨æ„äº‹é …ãªã©"></textarea>
                </div>
            </div>

            <div class="section">
                <button class="save-btn" onclick="saveChart()">ğŸ’¾ ã‚«ãƒ«ãƒ†ã‚’ä¿å­˜</button>
                <button class="save-btn" onclick="newChart()">ğŸ“ æ–°è¦ã‚«ãƒ«ãƒ†</button>
               
                <div class="file-controls">
                    <button class="save-btn" onclick="exportToJSON()">ğŸ“¥ JSONãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                    <label class="save-btn" style="display: inline-block; text-align: center;">
                        ğŸ“¤ JSONèª­è¾¼
                        <input type="file" accept=".json" onchange="importFromJSON(event)" style="display:none">
                    </label>
                </div>
            </div>

            <div class="section">
                <h2>é¡§å®¢ä¸€è¦§</h2>
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="ğŸ” é¡§å®¢åã€æ‹…å½“è€…ã€é›»è©±ç•ªå·ã§æ¤œç´¢..." oninput="searchCustomers()">
                </div>
                <div id="customerList" class="customer-list"></div>
            </div>
        </div>
    </div>

    <script>
        const PASSWORD = 'salon2024';
        let canvas, ctx;
        let isDrawing = false;
        let currentColor = 'black';
        let brushSize = 2;
        let currentView = 'front';
        let drawingHistory = [];
        let historyStep = -1;
        let customImage = null;
        let currentLicense = null;

        const viewData = {
            'front': [], 'back': [], 'left': [], 'right': [],
            'left-front': [], 'right-front': [], 'left-back': [], 'right-back': []
        };

        // ãƒ‡ãƒã‚¤ã‚¹IDã‚’ç”Ÿæˆï¼ˆiPadå›ºæœ‰ã®è­˜åˆ¥å­ï¼‰
        function getDeviceId() {
            const ua = navigator.userAgent;
            const screen_data = screen.width + 'x' + screen.height + 'x' + screen.colorDepth;
            const canvas_fp = getCanvasFingerprint();
            const webgl_fp = getWebGLFingerprint();
           
            const combined = ua + screen_data + canvas_fp + webgl_fp;
            return hashString(combined);
        }

        // CanvasæŒ‡ç´‹
        function getCanvasFingerprint() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            ctx.textBaseline = 'top';
            ctx.font = '14px Arial';
            ctx.fillText('fingerprint', 2, 2);
            return canvas.toDataURL();
        }

        // WebGLæŒ‡ç´‹
        function getWebGLFingerprint() {
            const canvas = document.createElement('canvas');
            const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
            if (!gl) return 'no-webgl';
           
            const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
            if (!debugInfo) return 'no-debug-info';
           
            return gl.getParameter(debugInfo.UNMASKED_VENDOR_WEBGL) + '~' +
                   gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL);
        }

        // æ–‡å­—åˆ—ã‚’ãƒãƒƒã‚·ãƒ¥åŒ–
        function hashString(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return Math.abs(hash).toString(36);
        }

        // ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã‚­ãƒ¼æ¤œè¨¼
        function validateLicense(licenseKey, deviceId = null) {
            if (!licenseKey) return { valid: false, error: 'ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã‚­ãƒ¼ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“' };
           
            const parts = licenseKey.toUpperCase().split('-');
           
            if (parts.length !== 4 || parts[0] !== 'SALON') {
                return { valid: false, error: 'ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã‚­ãƒ¼ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“' };
            }
           
            const shopId = parts[1];
            const expireDateStr = parts[2];
            const checksum = parts[3];
           
            if (expireDateStr.length !== 8) {
                return { valid: false, error: 'ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã‚­ãƒ¼ã®å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“' };
            }
           
            const year = expireDateStr.substring(0, 4);
            const month = expireDateStr.substring(4, 6);
            const day = expireDateStr.substring(6, 8);
            const expireDate = new Date(year, month - 1, day);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
           
            if (expireDate < today) {
                return {
                    valid: false,
                    expired: true,
                    error: 'ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã‚­ãƒ¼ã®æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¦ã„ã¾ã™',
                    expireDate: expireDate
                };
            }
           
            const expectedChecksum = simpleHash(shopId + expireDateStr);
            if (checksum !== expectedChecksum) {
                return { valid: false, error: 'ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã‚­ãƒ¼ãŒç„¡åŠ¹ã§ã™' };
            }
           
            // ãƒ‡ãƒã‚¤ã‚¹ç´ä»˜ã‘ãƒã‚§ãƒƒã‚¯
            if (deviceId) {
                const savedDeviceId = localStorage.getItem('device_' + licenseKey);
                if (savedDeviceId && savedDeviceId !== deviceId) {
                    return {
                        valid: false,
                        deviceMismatch: true,
                        error: 'ã“ã®ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã‚­ãƒ¼ã¯åˆ¥ã®ãƒ‡ãƒã‚¤ã‚¹ã«ç´ä»˜ã‘ã‚‰ã‚Œã¦ã„ã¾ã™'
                    };
                }
            }
           
            const daysUntilExpire = Math.ceil((expireDate - today) / (1000 * 60 * 60 * 24));
            const warning = daysUntilExpire <= 30 ? `ãƒ©ã‚¤ã‚»ãƒ³ã‚¹æœ‰åŠ¹æœŸé™ã¾ã§æ®‹ã‚Š${daysUntilExpire}æ—¥ã§ã™` : null;
           
            return {
                valid: true,
                shopId: shopId,
                expireDate: expireDate,
                daysUntilExpire: daysUntilExpire,
                warning: warning
            };
        }

        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = ((hash << 5) - hash) + str.charCodeAt(i);
                hash = hash & hash;
            }
            return Math.abs(hash).toString(36).toUpperCase().substring(0, 6);
        }

        function generateLicense(shopId, expireDate) {
            const dateStr = expireDate.toISOString().split('T')[0].replace(/-/g, '');
            const checksum = simpleHash(shopId + dateStr);
            return `SALON-${shopId}-${dateStr}-${checksum}`;
        }

        function login() {
            const password = document.getElementById('passwordInput').value;
            const licenseKey = document.getElementById('licenseInput').value.trim();
            const deviceId = getDeviceId();
           
            document.getElementById('errorMessage').textContent = '';
            document.getElementById('successMessage').textContent = '';
           
            if (password !== PASSWORD) {
                document.getElementById('errorMessage').textContent = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“';
                return;
            }
           
            const validation = validateLicense(licenseKey, deviceId);
           
            if (!validation.valid) {
                if (validation.expired) {
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('expiredScreen').style.display = 'block';
                } else if (validation.deviceMismatch) {
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('deviceErrorScreen').style.display = 'block';
                } else {
                    document.getElementById('errorMessage').textContent = validation.error;
                }
                return;
            }
           
            // åˆå›ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã«ãƒ‡ãƒã‚¤ã‚¹IDã‚’ä¿å­˜
            if (!localStorage.getItem('device_' + licenseKey)) {
                localStorage.setItem('device_' + licenseKey, deviceId);
            }
           
            currentLicense = {
                key: licenseKey,
                shopId: validation.shopId,
                expireDate: validation.expireDate,
                daysUntilExpire: validation.daysUntilExpire,
                deviceId: deviceId
            };
            localStorage.setItem('currentLicense', JSON.stringify(currentLicense));
           
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
           
            showLicenseInfo();
            initCanvas();
            loadCustomerList();
            document.getElementById('visitDate').valueAsDate = new Date();
        }

        function showLicenseInfo() {
            if (!currentLicense) return;
           
            const expireDateStr = currentLicense.expireDate.toLocaleDateString('ja-JP');
            const infoDiv = document.getElementById('licenseInfo');
            infoDiv.innerHTML = `<strong>åº—èˆ—ID:</strong> ${currentLicense.shopId} | <strong>ãƒ©ã‚¤ã‚»ãƒ³ã‚¹æœ‰åŠ¹æœŸé™:</strong> ${expireDateStr} | <strong>ğŸ“± ã“ã®ãƒ‡ãƒã‚¤ã‚¹ã«ç´ä»˜ã‘æ¸ˆ</strong>`;
           
            if (currentLicense.daysUntilExpire <= 30) {
                const warningDiv = document.getElementById('licenseWarning');
                warningDiv.style.display = 'block';
                warningDiv.innerHTML = `âš ï¸ ãƒ©ã‚¤ã‚»ãƒ³ã‚¹æœ‰åŠ¹æœŸé™ã¾ã§æ®‹ã‚Š<strong>${currentLicense.daysUntilExpire}æ—¥</strong>ã§ã™ã€‚æ›´æ–°ã‚’ã”æ¤œè¨ãã ã•ã„ã€‚`;
            }
        }

        function logout() {
            if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                localStorage.removeItem('currentLicense');
                location.reload();
            }
        }

        window.addEventListener('load', function() {
            const savedLicense = localStorage.getItem('currentLicense');
            if (savedLicense) {
                currentLicense = JSON.parse(savedLicense);
                currentLicense.expireDate = new Date(currentLicense.expireDate);
               
                const currentDeviceId = getDeviceId();
                const validation = validateLicense(currentLicense.key, currentDeviceId);
               
                if (validation.valid) {
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('mainApp').style.display = 'block';
                    showLicenseInfo();
                    initCanvas();
                    loadCustomerList();
                } else {
                    localStorage.removeItem('currentLicense');
                    if (validation.expired) {
                        document.getElementById('loginScreen').style.display = 'none';
                        document.getElementById('expiredScreen').style.display = 'block';
                    } else if (validation.deviceMismatch) {
                        document.getElementById('loginScreen').style.display = 'none';
                        document.getElementById('deviceErrorScreen').style.display = 'block';
                    }
                }
            }
        });

        function initCanvas() {
            canvas = document.getElementById('drawingCanvas');
            ctx = canvas.getContext('2d');
           
            canvas.width = 800;
            canvas.height = 400;
           
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
           
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
           
            canvas.addEventListener('touchstart', handleTouchStart, {passive: false});
            canvas.addEventListener('touchmove', handleTouchMove, {passive: false});
            canvas.addEventListener('touchend', handleTouchEnd, {passive: false});
           
            loadViewData();
        }

        function handleTouchStart(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const rect = canvas.getBoundingClientRect();
            const x = touch.clientX - rect.left;
            const y = touch.clientY - rect.top;
           
            isDrawing = true;
            ctx.beginPath();
            ctx.moveTo(x, y);
            saveState();
        }

        function handleTouchMove(e) {
            if (!isDrawing) return;
            e.preventDefault();
           
            const touch = e.touches[0];
            const rect = canvas.getBoundingClientRect();
            const x = touch.clientX - rect.left;
            const y = touch.clientY - rect.top;
           
            ctx.strokeStyle = currentColor;
            ctx.lineWidth = brushSize;
            ctx.lineTo(x, y);
            ctx.stroke();
        }

        function handleTouchEnd(e) {
            e.preventDefault();
            isDrawing = false;
            saveViewData();
        }

        function startDrawing(e) {
            isDrawing = true;
            const rect = canvas.getBoundingClientRect();
            ctx.beginPath();
            ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
            saveState();
        }

        function draw(e) {
            if (!isDrawing) return;
           
            const rect = canvas.getBoundingClientRect();
            ctx.strokeStyle = currentColor;
            ctx.lineWidth = brushSize;
            ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
            ctx.stroke();
        }

        function stopDrawing() {
            isDrawing = false;
            saveViewData();
        }

        function saveState() {
            historyStep++;
            if (historyStep < drawingHistory.length) {
                drawingHistory.length = historyStep;
            }
            drawingHistory.push(canvas.toDataURL());
        }

        function undo() {
            if (historyStep > 0) {
                historyStep--;
                const img = new Image();
                img.src = drawingHistory[historyStep];
                img.onload = () => {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0);
                };
            }
        }

        function redo() {
            if (historyStep < drawingHistory.length - 1) {
                historyStep++;
                const img = new Image();
                img.src = drawingHistory[historyStep];
                img.onload = () => {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0);
                };
            }
        }

        function clearCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (customImage) {
                ctx.drawImage(customImage, 0, 0, canvas.width, canvas.height);
            }
            saveState();
            saveViewData();
        }

        function selectColor(color) {
            currentColor = color;
            document.querySelectorAll('.color-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        function updateBrushSize(size) {
            brushSize = size;
            document.getElementById('sizeDisplay').textContent = size + 'px';
        }

        function changeView(view) {
            saveViewData();
            currentView = view;
           
            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
           
            loadViewData();
        }

        function saveViewData() {
            viewData[currentView] = canvas.toDataURL();
        }

        function loadViewData() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
           
            if (customImage) {
                ctx.drawImage(customImage, 0, 0, canvas.width, canvas.height);
            }
           
            if (viewData[currentView]) {
                const img = new Image();
                img.src = viewData[currentView];
                img.onload = () => ctx.drawImage(img, 0, 0);
            }
        }

        function uploadCustomImage(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    customImage = new Image();
                    customImage.onload = function() {
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        ctx.drawImage(customImage, 0, 0, canvas.width, canvas.height);
                        document.getElementById('currentImage').src = event.target.result;
                        document.getElementById('currentImage').style.display = 'block';
                        saveState();
                    };
                    customImage.src = event.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        function saveChart() {
            saveViewData();
           
            const chartData = {
                id: Date.now(),
                customerName: document.getElementById('customerName').value,
                staffName: document.getElementById('staffName').value,
                visitDate: document.getElementById('visitDate').value,
                phoneNumber: document.getElementById('phoneNumber').value,
                menus: Array.from(document.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.id),
                drawings: viewData,
                customImage: customImage ? customImage.src : null,
                hairDetails: {
                    length: document.getElementById('length').value,
                    cutStyle: document.getElementById('cutStyle').value,
                    hairColor: document.getElementById('hairColor').value,
                    colorLevel: document.getElementById('colorLevel').value,
                    permType: document.getElementById('permType').value,
                    rodSize: document.getElementById('rodSize').value,
                    bangs: document.getElementById('bangs').value,
                    faceFrame: document.getElementById('faceFrame').value,
                    volume: document.getElementById('volume').value,
                    otherTech: document.getElementById('otherTech').value,
                    notes: document.getElementById('notes').value
                }
            };
           
            let charts = JSON.parse(localStorage.getItem('salonCharts') || '[]');
            const existingIndex = charts.findIndex(c => c.id === chartData.id);
           
            if (existingIndex >= 0) {
                charts[existingIndex] = chartData;
            } else {
                charts.push(chartData);
            }
           
            localStorage.setItem('salonCharts', JSON.stringify(charts));
            alert('ã‚«ãƒ«ãƒ†ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
            loadCustomerList();
        }

        function newChart() {
            if (confirm('æ–°è¦ã‚«ãƒ«ãƒ†ã‚’ä½œæˆã—ã¾ã™ã‹ï¼Ÿæœªä¿å­˜ã®ãƒ‡ãƒ¼ã‚¿ã¯å¤±ã‚ã‚Œã¾ã™ã€‚')) {
                document.getElementById('customerName').value = '';
                document.getElementById('staffName').value = '';
                document.getElementById('phoneNumber').value = '';
                document.getElementById('visitDate').valueAsDate = new Date();
                document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
               
                Object.keys(viewData).forEach(view => viewData[view] = []);
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                customImage = null;
                document.getElementById('currentImage').style.display = 'none';
               
                document.querySelectorAll('.hair-details input, .hair-details select, #notes').forEach(el => el.value = '');
               
                currentView = 'front';
                document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelector('.view-btn').classList.add('active');
            }
        }

        function loadCustomerList() {
            const charts = JSON.parse(localStorage.getItem('salonCharts') || '[]');
            const listDiv = document.getElementById('customerList');
           
            listDiv.innerHTML = charts.sort((a, b) => b.id - a.id).map(chart => `
                <div class="customer-item" onclick="loadChart(${chart.id})">
                    <strong>${chart.customerName}</strong> ${chart.staffName ? `(æ‹…å½“: ${chart.staffName})` : ''} | ${chart.visitDate} | ${chart.phoneNumber}
                </div>
            `).join('');
        }

        function searchCustomers() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            const charts = JSON.parse(localStorage.getItem('salonCharts') || '[]');
           
            const filtered = charts.filter(chart =>
                chart.customerName.toLowerCase().includes(query) ||
                chart.phoneNumber.includes(query) ||
                (chart.staffName && chart.staffName.toLowerCase().includes(query))
            );
           
            const listDiv = document.getElementById('customerList');
            listDiv.innerHTML = filtered.map(chart => `
                <div class="customer-item" onclick="loadChart(${chart.id})">
                    <strong>${chart.customerName}</strong> ${chart.staffName ? `(æ‹…å½“: ${chart.staffName})` : ''} | ${chart.visitDate} | ${chart.phoneNumber}
                </div>
            `).join('');
        }

        function loadChart(id) {
            const charts = JSON.parse(localStorage.getItem('salonCharts') || '[]');
            const chart = charts.find(c => c.id === id);
           
            if (chart) {
                document.getElementById('customerName').value = chart.customerName;
                document.getElementById('staffName').value = chart.staffName || '';
                document.getElementById('visitDate').value = chart.visitDate;
                document.getElementById('phoneNumber').value = chart.phoneNumber;
               
                document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                    cb.checked = chart.menus.includes(cb.id);
                });
               
                Object.assign(viewData, chart.drawings);
               
                if (chart.customImage) {
                    customImage = new Image();
                    customImage.src = chart.customImage;
                    document.getElementById('currentImage').src = chart.customImage;
                    document.getElementById('currentImage').style.display = 'block';
                }
               
                if (chart.hairDetails) {
                    document.getElementById('length').value = chart.hairDetails.length || '';
                    document.getElementById('cutStyle').value = chart.hairDetails.cutStyle || '';
                    document.getElementById('hairColor').value = chart.hairDetails.hairColor || '';
                    document.getElementById('colorLevel').value = chart.hairDetails.colorLevel || '';
                    document.getElementById('permType').value = chart.hairDetails.permType || '';
                    document.getElementById('rodSize').value = chart.hairDetails.rodSize || '';
                    document.getElementById('bangs').value = chart.hairDetails.bangs || '';
                    document.getElementById('faceFrame').value = chart.hairDetails.faceFrame || '';
                    document.getElementById('volume').value = chart.hairDetails.volume || '';
                    document.getElementById('otherTech').value = chart.hairDetails.otherTech || '';
                    document.getElementById('notes').value = chart.hairDetails.notes || '';
                }
               
                loadViewData();
            }
        }

        function exportToJSON() {
            const charts = JSON.parse(localStorage.getItem('salonCharts') || '[]');
            const dataStr = JSON.stringify(charts, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `salon_charts_${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importFromJSON(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const charts = JSON.parse(event.target.result);
                        localStorage.setItem('salonCharts', JSON.stringify(charts));
                        alert('ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼');
                        loadCustomerList();
                    } catch (error) {
                        alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    }
                };
                reader.readAsText(file);
            }
        }

        document.getElementById('passwordInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('licenseInput').focus();
            }
        });

        document.getElementById('licenseInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                login();
            }
        });
    </script>
</body>
</html> 
